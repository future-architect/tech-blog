---
title: '住所情報から経路を探索する"そこそこ"な方法'
date: 2022/07/22 00:00:00
postid: a
tag:
  - 初心者向け
  - 地図
  - GoogleMap
category:
  - DataScience
thumbnail: /images/20220722a/thumbnail.png
author: 塚本祥太
lede: 'ユーザ等から登録された住所情報から、ある程度精度を犠牲にすることで安価に経路を探索できる状態する、つまり"そこそこ"な方法について紹介します。なお紹介する内容は当社でアルバイトとして活躍している大森さん・高倉さんの協力を得ています。'
---
## はじめに
SAIG(Strategic AI Group)の塚本です。[地図・GIS・位置特定](/articles/20220719a/)連載の4本目です。

私はAIチームにてアルゴリズム案件に携わっているのですが、アルゴリズム案件の代表的な課題のひとつに経路最適化があります。経路最適化自体の方法は[以前の記事](/articles/20211201a/)を参照下さい。

本記事ではユーザ等から登録された住所情報から、ある程度精度を犠牲にすることで安価に経路を探索できる状態する、つまり"そこそこ"な方法について紹介します。なお紹介する内容は当社でアルバイトとして活躍している大森さん・高倉さんの協力を得ています。

## 経路を探索できる状態ができるまで

複数の住所を順番に訪れる経路を探索するには、各訪問先をノード、訪問先と訪問先の最短の道をエッジとしたグラフネットワーク構造で表す必要があります。
<img src="/images/20220722a/image.png" alt="" width="595" height="488" loading="lazy">

入力情報がすでに構造化されたデータであれば良いのですが、実際は絶対的な位置である緯度経度ですら記録されておらず、曖昧な住所情報という形で記録されている事が多いです。
そのため、住所情報から経路探索をするために、以下のstepが必要です。
1. 文字列である住所情報から緯度経度を求める
1. 求めた緯度経度同士をつなぐ最短の道の長さを求める

各stepの実現方法を以下で紹介します。なお、本記事では地図情報を Google Map API にて取得します。

### 1. 文字列である住所情報から緯度経度を求める
多くの場合、住所は文字で書かれており表記に揺れがあります。また、住所としては正しくても、地図情報中に存在しなかったり、複数の可能性が発生することは珍しくありません。実際の住所情報をもとに説明します。
なお、以下はWebページでの Google Map の結果を記載しておりますが、APIでの結果も同様の傾向にあります。

例えば、当社の下記住所を Google Map に入力すると、その所在は一意に求まります。[Google Map](https://www.google.com/maps/place/%E3%82%A2%E3%83%BC%E3%83%88%E3%83%B4%E3%82%A3%E3%83%AC%E3%83%83%E3%82%B8%E5%A4%A7%E5%B4%8E%E3%82%BB%E3%83%B3%E3%83%88%E3%83%A9%E3%83%AB%E3%82%BF%E3%83%AF%E3%83%BC/@35.6223814,139.7252707,17z/data=!3m2!4b1!5s0x60188af7290db429:0x256fd7e2182150d7!4m5!3m4!1s0x60188af729b7a60d:0xc6703259ca319f2f!8m2!3d35.6223771!4d139.7274594)
`東京都品川区大崎1-2-2アートヴィレッジ大崎セントラルタワー`

<img src="/images/20220722a/image_2.png" alt="" width="545" height="309" loading="lazy">

ところが、この住所を少し変えると、複数の候補がサジェストされます。[Google Map](https://www.google.com/maps/search/%E6%9D%B1%E4%BA%AC%E9%83%BD%E5%93%81%E5%B7%9D%E5%8C%BA%E5%A4%A7%E5%B4%8E1-2-2%E3%82%A2%E3%83%BC%E3%83%88%E3%83%B4%E3%82%A3%E3%83%AC%E3%83%83%E3%82%B8/@35.6226561,139.7249502,17z/data=!3m1!4b1)
`東京都品川区大崎1-2-2アートヴィレッジ`

<img src="/images/20220722a/image_3.png" alt="" width="543" height="309" loading="lazy">

一方、建物名を除外するとまた一意に求まります。[Google Map](https://www.google.com/maps/place/%E3%80%92141-0032+%E6%9D%B1%E4%BA%AC%E9%83%BD%E5%93%81%E5%B7%9D%E5%8C%BA%E5%A4%A7%E5%B4%8E%EF%BC%91%E4%B8%81%E7%9B%AE%EF%BC%92%E2%88%92%EF%BC%92/@35.6223196,139.7249758,17z/data=!3m1!4b1!4m5!3m4!1s0x60188af728214857:0xea57823db5ffb40a!8m2!3d35.6223153!4d139.7271645)
```東京都品川区大崎1-2-2```

<img src="/images/20220722a/image_4.png" alt="" width="544" height="308" loading="lazy">

例として説明した「アートヴィレッジ大崎セントラルタワー」は、商業ビルであり建物自体が Google Map に登録されていますが、これが小さなマンションや個人宅等になると未登録や、表記ゆれで一意に求めることが困難になります。先の例はそれほど距離が離れてませんが、実際の住所データで検証した所、1駅以上離れた候補が複数サジェストされる状況はよく発生し、複数の所在からどれを正しいものと選択するかによって経路が大きく変わってしまいます。

そこで、私は住所情報から所在がわからなかったり複数サジェストされた場合、後ろから記載を削り経路に大きく影響を及ぼさない**番地**までの所在を求められるよう、加工処理を加えるようにしています。[Google Map](https://www.google.com/maps/place/%E3%80%92141-0032+%E6%9D%B1%E4%BA%AC%E9%83%BD%E5%93%81%E5%B7%9D%E5%8C%BA%E5%A4%A7%E5%B4%8E%EF%BC%91%E4%B8%81%E7%9B%AE%EF%BC%92/@35.6225215,139.7253501,17z/data=!3m1!4b1!4m5!3m4!1s0x60188af7262641f1:0xd7cfc3a7a3c0382c!8m2!3d35.6223847!4d139.727363)
`東京都品川区大崎1-2`

<img src="/images/20220722a/image_5.png" alt="" width="545" height="310" loading="lazy">

住所情報からの所在特定は地域性に大きく左右されるのですが、実際にあった顧客リストの住所情報をそのまま Google Map API を用いて所在を特定しようとした所、無加工の場合全体の80%程度しか取得ができませんでしたが、上記工夫を入れることで90%超の所在特定ができました。

### 2. 求めた緯度経度同士をつなぐ最短の道の長さを求める
step1 で求めた所在(緯度経度)について、全ての地点を結ぶ最短の道の長さを Google Map API を用いて取得する事は現実的でありません。有料のサービスであるため、金額的にもなるべく少ない取得回数で妥当な結果を得たいです。

実世界の特に日本では、訪問先までの最短路の長さは2点間の直線距離に比例すると期待できます。そこで、どの程度の精度で近似できるのか、実際に下図で示したエリアにランダムに点を打ち、各2点間を結ぶ距離と、Google Map API による実際の最短路の長さの誤差を検証します。

<img src="/images/20220722a/plot.png" alt="" width="640" height="640" loading="lazy">

初めに打った20点から、各2点の直線距離(ユークリッド距離)とGoogle Map API による実際の最短路の長さを比較し、最小二乗法にて誤差最小となる相関係数 *C* を求めます。

再度ランダムに20点打ち、ユークリッド距離に相関係数 *C* を書けた値と、Google Map API による実際の最短路の長さを比較したグラフが下図です。近距離の場合は誤差が大きいですが、それ以外は1.2～0.8倍に収まっており、それほど悪くない精度です。

<img src="/images/20220722a/2.png" alt="" width="589" height="232" loading="lazy">

上記結果より、緯度経度から求められるユークリッド距離にて経路の候補を探索し、上位数点の候補のみ実際に Google Map API にて最短路を取得することで、API使用頻度を落としつつ、それなりの解を得ることができます。

## まとめ

本記事では住所情報から経路を探索を実現するために、住所の加工による所在特定成功率の向上と地点間の最短路の長さを近似する、"そこそこ"な方法について、実際の Google Map API の動作を交えて紹介しました。世の中にはすでに優れたルート最適化サービスが存在する一方、利用シーンやコスト対効果に合致しない場面も多いかと思います。そのような場合に簡易な処理と安価な汎用サービスの組み合わせでは、どの程度の精度で実現できるかの指標となれば幸いです。

次は岸下さんによる[Bluetoothで位置推定](/articles/20220725a/) です。
