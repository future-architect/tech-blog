title: "Terraform 101"
date: 2020/06/24 11:44:35
postid: ""
tag:
  - Terraform
  - Ansible
  - åˆå¿ƒè€…å‘ã‘
  - GCP
  - IaC
category:
  - Infrastructure
thumbnail: /images/20200624/thumbnail.png
author: ä¼Šè—¤å¤ªæ–‰
featured: false
lede: "Infrastructure as Code(IaC)ã®ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯AWSã‹ã‚‰ã¯CloudFormationã€GCPã‹ã‚‰ã¯Deployment ManagerãŒå‡ºã¦ã„ã¾ã™ã€‚Terraformã¯å˜ä¸€ãƒ„ãƒ¼ãƒ«ã§è¤‡æ•°ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã¨ã„ã†ã“ã¨ãŒå¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã¯ä¸–ã«å‡ºã¦ã„ã‚‹ä»–ã®è¨˜äº‹ã§ã‚‚è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚"
---

<img src="/images/20200624/photo_20200624_01.png" class="img-middle-size">

ã“ã‚“ã«ã¡ã¯ã€‚TIG/DXãƒ¦ãƒ‹ãƒƒãƒˆã®ä¼Šè—¤ã§ã™ã€‚æœ¬è¨˜äº‹ã¯[æ˜¥ã®å…¥é–€ç¥­ã‚Š](articles/20200529/)ã®ç¬¬18å¼¾ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã€Terraformã®å…¥é–€è¨˜äº‹ã§ã™ã€‚Infrastructure as Code(IaC)ã®ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯AWSã‹ã‚‰ã¯CloudFormationã€GCPã‹ã‚‰ã¯Deployment ManagerãŒå‡ºã¦ã„ã¾ã™ã€‚Terraformã¯å˜ä¸€ãƒ„ãƒ¼ãƒ«ã§è¤‡æ•°ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã¨ã„ã†ã“ã¨ãŒå¤§ããªãƒ¡ãƒªãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ã¯ä¸–ã«å‡ºã¦ã„ã‚‹ä»–ã®è¨˜äº‹ã§ã‚‚è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ä»¥å‰ç§ãŒã“ã®å…¥é–€è¨˜äº‹é€£è¼‰ã§ä¸Šã’ãŸã€Œ[æ˜¥ã®å…¥é–€ç¥­ã‚Š ğŸŒ¸ #02 Google Cloud Platform 101](/articles/20200602/)ã€ã®å†…å®¹ã‚’æ‰±ã„ã¾ã™ã€‚ãªã®ã§ã€ä»Šå›ã¯GCP+Terraformã®çµ„ã¿åˆã‚ã›ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰åŒ–ã™ã‚‹ã¨ã“ã‚ãŒåŸºæœ¬ç·¨ã€Terraform Cloudã®å°å…¥ã‚’ã‚’å¿œç”¨ç·¨ã¨ã—ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚é•·ããªã‚‹ã‹ã‚‚ã§ã™ãŒã€ãŠä»˜ãåˆã„ãã ã•ã„ã€‚


# Terraformã«ã¤ã„ã¦

ã¯ã˜ã‚ã¯Terraformã®ç°¡å˜ãªèª¬æ˜ã‚’ã—ã¦ã„ãã¾ã™ã€‚Terraformã¯ã€HashiCorpç¤¾ãŒé–‹ç™ºã—ãŸInfrastructure as Code(IaC)ã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦ã„ãä¸­ã§ä»¥ä¸‹ã®åƒãã‚’ç†è§£ã—ãªãŒã‚‰é€²ã‚ã‚‹ã¨ã©ã‚“ãªé¢¨ã«TerraformãŒå‹•ã„ã¦ã„ã‚‹ã‹ã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

- resource
    - äººãŒå®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã«æ›¸ãã‚³ãƒ¼ãƒ‰ã€‚ä½œæˆå¾Œã‚‚ã‚³ãƒ¼ãƒ‰ã‚’å·®åˆ†ã‚’é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
- tfstate
    - å®Ÿåœ¨ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã€Œã‚ã‚‹ã¹ãçŠ¶æ…‹ã€ã‚’å®šç¾©ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹ã¨tfstateã‚‚ã‚³ãƒ¼ãƒ‰ã«å³ã—ãŸçŠ¶æ…‹ã«ãªã‚‹ã€‚
- provider
    - å„ã‚¯ãƒ©ã‚¦ãƒ‰ã®APIã‚’TerraformãŒå®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€‚ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã—ã¦ä½œæˆã™ã‚‹æ™‚ã«å¿…è¦ã€‚

## æº–å‚™
Terraformã‚’å®Ÿè¡Œã§ãã‚‹æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ä»Šå›ã®è¨˜äº‹ã®ä½œæˆã«å½“ãŸã£ã¦ã®å®Ÿè¡Œç’°å¢ƒã¯ä»¥ä¸‹ã§ã™ã€‚

- MacBook 16inch(2019)
- OS: Catalina
- Terraform version: 0.12.24
- Editor: VS Code

Terraformã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã€Macã®æ–¹ã§ã‚ã‚Œã°ã€HomebrewçµŒç”±ã§ã§ãã¾ã™ã€‚ãªã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç°¡å˜ã«æ‰‹ã«å…¥ã‚Šã¾ã™ã€‚ä¾¿åˆ©ã€‚

```shell
$ brew install terraform
$ terraform version # Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
```

æ¬¡ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã€ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã¯æ˜¨ä»Š[ã“ã‚“ãªè¨˜äº‹](https://note.com/munmun1234/n/n7515fef76041)ã‚‚å‡ºã¦ã„ã¾ã™ã®ã§ã€æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã¯ã€GCPã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã®ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ˆã‚Šã€[IAMã¨ç®¡ç†]>[ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ]ã‹ã‚‰ã§ãã¾ã™ã€‚ä½•å›ã‹å…¥åŠ›ã¨æ¬¡ã«é€²ã‚€ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

| é …ç›® | å†…å®¹ |
| ----- | ----- |
| ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå | terraform |
| ãƒ­ãƒ¼ãƒ« | ç·¨é›†è€…(editor) |
| ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ­ãƒ¼ãƒ« | è‡ªåˆ†ã®ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |

ä½œæˆã§ããŸã‚‰ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®è©³ç´°ã«è¡Œãã€[éµã®è¿½åŠ ]ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚jsonã‹P12ã‹ã‚’é¸æŠã§ãã¾ã™ãŒã€ä»Šå›ã¯jsonã‚’é¸æŠã—ã¾ã™ã€‚è‡ªå‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã®ã§ã€ä»Šå›ã¯ã“ã®ã‚­ãƒ¼åã‚’`credentials.json`ã¨åå‰ã‚’å¤‰æ›´ã—ã¦ä»Šå›ä½¿ç”¨ã™ã‚‹Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ã‚³ãƒ¼ãƒ‰å´ã§ã‚‚ä¸€ã¤æº–å‚™ã—ã¦ãŠãã¾ã™ã€‚`provider`ã¨å‘¼ã°ã‚Œã‚‹å„ã‚¯ãƒ©ã‚¦ãƒ‰ã®APIã‚’TerraformãŒå©ããŸã‚ã®ãƒã‚¤ãƒŠãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’Terraformã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æº–å‚™ã—ã¦ãã ã•ã„ã€‚

```sh provider.tf
provider "google" {
  project = "xxxxxxxxxx" # ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  credentials = file("credentials.json")
}
```
ã‚³ãƒ¼ãƒ‰ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãŒæº–å‚™ã§ããŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€Terraformã®æº–å‚™ã‚’ã—ã¾ã™ã€‚

```shell
$ terraform init

Initializing the backend...

Initializing provider plugins...
- Checking for available provider plugins...
- Downloading plugin for provider "google" (hashicorp/google) 3.26.0...

...

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
```

ã“ã®`init`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§`.terraform`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ã€å®šç¾©ã•ã‚Œã¦ã„ã‚‹`provider`ã‚„ã‚ã¨ã§å‡ºã¦ãã‚‹`backend`ãªã©ã€Terraformã®ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ãªãè¨­å®šã«é–¢ã‚ã‚‹éƒ¨åˆ†ã‚’åˆæœŸåŒ–ã—ã¦ãã‚Œã¾ã™ã€‚ãªã®ã§ã€è¤‡æ•°äººã§Gitç®¡ç†ã—ã¦ã„ã‚‹æ™‚ã«ã‚‚é€šå¸¸ã¯`.terraform`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç®¡ç†ã«å…¥ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚
ã•ã¦ã€ã“ã‚Œã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æº–å‚™ãŒã§ããŸã®ã§ã€ã„ã‚ˆã„ã‚ˆTerraformã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ï¼ï¼

# åŸºæœ¬ç·¨
å…¥é–€è¨˜äº‹ã‹ã‚‰ã®å†æ²ã«ãªã‚Šã¾ã™ãŒã€ä»¥ä¸‹ã®æ§‹æˆã‚’åŸºæœ¬ç·¨ã§è¡Œã£ã¦ã„ãã¾ã™ã€‚æ‰‹ã§çµ„ã‚“ã§ã¿ã¦ã‹ã‚‰ã®æ–¹ãŒå®Ÿéš›ã«TerraformãŒä¾¿åˆ©ã¨ã„ã†ã“ã¨ã«æ°—ãŒã¤ã‘ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
<img src="/images/20200624/photo_20200624_02.png">
ã¾ãšã¯å¤§æ ã®VPCã‚„ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¦ã‹ã‚‰GCEã‚„NATãªã©ã‚’ç«‹ã¦ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹ç¯‰
ã¯ã˜ã‚ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯[VPC](https://www.terraform.io/docs/providers/google/r/compute_network.html)ã¨[ã‚µãƒ–ãƒãƒƒãƒˆ](https://www.terraform.io/docs/providers/google/r/compute_subnetwork.html)ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚Terraformã¯ã‚³ãƒ¼ãƒ‰åŒ–ã™ã‚‹æ™‚ã«ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¿…é ˆãªã®ã§ã€æ˜¯éå…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ã—ã¾ã—ãŸã€‚`auto_create_subnetworks = false`ã¨ã—ã¦ã„ã‚‹ã®ã¯ä¸å¿…è¦ãªã‚µãƒ–ãƒãƒƒãƒˆä½œæˆã‚’æŠ‘ãˆã‚‹ãŸã‚ã§ã™ã€‚

```sh compute_network.tf
resource "google_compute_network" "sample_network" {
  name = "sample-network"
  auto_create_subnetworks = false
}
```
ã“ã‚Œã§VPCéƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’é©ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```shell
$ terraform fmt # ã‚³ãƒ¼ãƒ‰ã®æ•´å½¢ã‚’ã—ã¦ãã‚Œã‚‹
$ terraform validate # ã‚³ãƒ¼ãƒ‰ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚„å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºèª
$ terraform plan # ã‚³ãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã‚’è¡Œã†
$ terraform apply # ã‚³ãƒ¼ãƒ‰ã‚’é©ç”¨ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
```
ã“ã‚Œã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æ˜¯éä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚ä¸Šã§ç¤ºã—ãŸ`network.tf`ã¯ã‚³ãƒ¼ãƒ‰ã®å½¢ãŒå´©ã‚Œã¦ã„ã¾ã™ãŒã€`fmt`ã‚³ãƒãƒ³ãƒ‰ã§æ•´å½¢ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚`apply`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ãŒå‡ºåŠ›ã•ã‚Œã€`yes`ã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

```shell
  # google_compute_network.sample_network will be created
  + resource "google_compute_network" "sample_network" {
      + auto_create_subnetworks         = false
      + delete_default_routes_on_create = false
      + gateway_ipv4                    = (known after apply)
      + id                              = (known after apply)
      + ipv4_range                      = (known after apply)
      + name                            = "sample-network"
      + project                         = (known after apply)
      + routing_mode                    = (known after apply)
      + self_link                       = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

ã‚‚ã—ã‹ã—ãŸã‚‰ApplyãŒã€ŒAPIã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ãªã„ã®ã§ã§ããªã„ã€ã¨å‡ºã‚‹æ–¹ã‚‚ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ãã®æ™‚ã¯GUIã§è©²å½“ã®APIã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚[APIã®æœ‰åŠ¹åŒ–ã¯ã“ã¡ã‚‰](https://cloud.google.com/endpoints/docs/frameworks/enable-api)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ApplyãŒå®Œäº†ã—ãŸã‚‰GUIã§ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã ã‘ã§ãã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
æ¬¡ã«ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```sh compute_subnetwork.tf
resource "google_compute_subnetwork" "pub_subnetwork" {
  name          = "sample-subnet-pub"
  ip_cidr_range = "192.168.1.0/24"
  region        = "asia-northeast1"
  network       = "sample-network"
}

resource "google_compute_subnetwork" "prv_subnetwork" {
  # å®Ÿéš›ã«æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†
}
```
ã“ã“ã§ã¯`sample-network`ã«ä½œã‚‹ã“ã¨ã‚’æŒ‡å®šã—ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä»–ã«ã‚‚æ§˜ã€…æ›¸ã‘ã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦è¿½è¨˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ä»Šå›ã¯ã‚µãƒ–ãƒãƒƒãƒˆã‚’2ã¤ä½œæˆã—ã¾ã™ãŒã€1ã¤ã¯ä½œæˆãœã²å®Ÿéš›ã«æ›¸ã„ã¦ã¿ã¦ãã ã•ã„ã€‚ç­”ãˆã¯[ã“ã¡ã‚‰](https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_subnetwork.tf)ã«ã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®æº–å‚™ãŒçµ‚ã‚ã£ãŸã‚‰Applyã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ä½œæˆ
æ¬¡ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰ä¿è­·ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãªã©ã®ä½œæˆã‚ˆã‚Šã‚‚ã“ã†ã„ã£ãŸãƒ«ãƒ¼ãƒ«å‘¨ã‚Šã®æ–¹ãŒTerraformãŒå½¹ç«‹ã¤å ´é¢ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚GCPã®å…¥é–€è¨˜äº‹ã§ã¯2ã¤ä½œæˆã—ãŸã®ã§ã€ä»Šå›ã‚‚2ã¤ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```sh compute_firewall.tf
resource "google_compute_firewall" "bastion" {
  name    = "bastion"
  network = "sample-network"

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags = ["bastion"]
}

resource "google_compute_firewall" "from_bastion" {
  name    = "from-bastion"
  network = "sample-network"

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  source_tags = ["bastion"]
  target_tags = ["from-bastion"]
}

resource "google_compute_firewall" "sample_network_allow_http" {
  name    = "sample-network-allow-http"
  network = "sample-network"

  allow {
    protocol = "tcp"
    ports    = ["80"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags = ["http-server"]
}
```
sshã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ã¯ä¸Šã®2ã¤ã€ä¸‹ã®`sample-network-allow-http`ã¯ã€GUIã§ã‚ã‚Œã°è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ãŒã€Terraformã ã¨ã§ããªã„ã®ã§ã€ä»Šå›ã¯ã‚³ãƒ¼ãƒ‰åŒ–ã—ã¦Applyã—ã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
ã¯ã˜ã‚ã«è¸ã¿å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰ä½œæˆã—ã¦ã„ãã¾ã™ã€‚è¸ã¿å°ã¯ã€å¤–éƒ¨IPãŒã¤ã„ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ä»¥ä¸‹ã®å½¢ã§æ›¸ãã¾ã™ã€‚

```sh compute_instance.tf
resource "google_compute_instance" "bastion" {
  name         = "bastion"
  machine_type = "n1-standard-1"
  zone         = "asia-northeast1-a"
  tags = ["bastion"]

  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-10"
    }
  }

  network_interface {
    subnetwork = "sample-subnet-pub"

    access_config {
      nat_ip = google_compute_address.bastion_external.address
    }
  }

  service_account {
    scopes = ["cloud-platform"]
  }
}

resource "google_compute_address" "bastion_external" {
  name         = "bastion-external"
  address_type = "EXTERNAL"
  region       = "asia-northeast1"
}
```

ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã‚’è¡Œã†`google_compute_instance`ã¨ã€å¤–éƒ¨IPã‚³ãƒ¼ãƒ‰ã§æ±ºã‚ã¦è¨­å®šã—ã¦ã„ã‚‹`google_compute_address`ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚webã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¤ã„ã¦ã¯å®Ÿéš›ã«æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å¤–éƒ¨IPã¯å¿…è¦ãªã„ã®ã§ã€`google_compute_instance`ã ã‘ã‚ã‚Œã°ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ç­”ãˆã®ä¾‹ã¯[ã“ã¡ã‚‰](https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_instance.tf)ã«ãªã‚Šã¾ã™ã€‚

### ãƒªã‚½ãƒ¼ã‚¹ã«ä¾å­˜é–¢ä¿‚ã‚’ã¤ã‘ã‚‹
ä»Šå›ã€GCEã®ä½œæˆã«ã‚ãŸã‚Šã€`access_config`ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã«`nat_ip = google_compute_address.bastion_external.address`ã¨ã„ã†æ›¸ãæ–¹ã‚’ã—ã¾ã—ãŸã€‚ã“ã®æ›¸ãæ–¹ã«ã¯ä¸»ã«2ã¤ç›®çš„ãŒã‚ã‚Šã€

- ä»–ã§ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹å€¤ã‚’åˆ©ç”¨ã™ã‚‹æ›¸ãæ–¹
    - ä»Šå›ã¯è©²å½“ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¼•ç”¨ã™ã‚‹æ›¸ãæ–¹ã«ãªã£ã¦ã„ã‚‹
- ãƒªã‚½ãƒ¼ã‚¹ã®ä¾å­˜é–¢ä¿‚ã‚’ã¤ã‘ã¦ãã‚Œã‚‹
    - ä»Šå›ã¯`google_compute_address.bastion_external`ãŒä½œæˆã•ã‚Œãªã„ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œãªã„

ãã®ãŸã‚ã€ã“ã‚Œã¾ã§å‡ºã¦ããŸãƒªã‚½ãƒ¼ã‚¹ã ã¨ã€VPCâ†’ã‚µãƒ–ãƒãƒƒãƒˆorãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ä½œæˆé †åºãŒå¥½ã¾ã—ã„ã®ã§ã€ã‚µãƒ–ãƒãƒƒãƒˆã‚’ä¾‹ã«ã™ã‚‹ã¨ã€

```sh compute_subnetwork.tf
resource "google_compute_subnetwork" "pub_subnetwork" {
  name          = "sample-subnet-pub"
  ip_cidr_range = "192.168.1.0/24"
  region        = "asia-northeast1"
  network       = google_compute_network.sample_network.id # ã“ã“ã‚’æ›¸ãæ›ãˆ
}

resource "google_compute_subnetwork" "prv_subnetwork" {
  # å®Ÿéš›ã«æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†
}
```

ã¨æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚ä»–ã«ã‚‚ä¿®æ­£ã§ãã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
webã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¤ã„ã¦ã¯å®Ÿéš›ã«æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å¤–éƒ¨IPã¯å¿…è¦ãªã„ã®ã§ã€`google_compute_instance`ã ã‘ã‚ã‚Œã°ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ç­”ãˆã®ä¾‹ã¯[ã“ã¡ã‚‰](https://github.com/kaedemalu/terraform_101_handon/blob/master/compute_instance.tf)ã«ãªã‚Šã¾ã™ã€‚

## ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã®ä½œæˆ
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã‚‹ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚GUIã§ã‚‚è¨­å®šãŒç´°ã‹ã„ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã§ã™ãŒã€Terraformã«ã—ã¦ãŠãã¨ã‚³ãƒ¼ãƒ‰ã§è¨­å®šãŒè¦‹ãˆã‚‹ã®ã§ã€ã‚ã¨ã§è¦‹è¿”ã™ã®ã«ã‚‚ãŠã™ã™ã‚ãªéƒ¨åˆ†ã§ã™ã€‚

```sh http_lb.tf
resource "google_compute_global_address" "web_lb" {
  name = "web-lb"
}

resource "google_compute_health_check" "web_health" {
  name = "web-health"
  timeout_sec        = 1
  check_interval_sec = 1
  tcp_health_check {
    port = "80"
  }
}

resource "google_compute_backend_service" "web_backend" {
  name        = "web-backend"
  port_name   = "http"
  protocol    = "HTTP"
  timeout_sec = 3000

  backend {
    group = google_compute_instance_group.web_instance_group.self_link
  }

  health_checks = [google_compute_health_check.web_health.self_link]
}

resource "google_compute_url_map" "web_lb" {
  name        = "web-lb"
  default_service = google_compute_backend_service.web_backend.self_link
}

resource "google_compute_target_http_proxy" "http_proxy" {
  name             = "http-proxy"
  url_map          = google_compute_url_map.web_lb.self_link
}

resource "google_compute_global_forwarding_rule" "forwarding_rule" {
  name       = "forwarding-rule"
  target     = google_compute_target_http_proxy.http_proxy.self_link
  port_range = "80"
  ip_address = google_compute_global_address.web_lb.address
}

resource "google_compute_instance_group" "web_instance_group" {
  name        = "web-instance-group"

  instances = [google_compute_instance.web_instance.self_link]

  zone = "asia-northeast3-a"
}
```

ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’1ã¤ä½œã‚‹ãŸã‚ã«æ§˜ã€…ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ãŒã€ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ã¯LBã‚’ä½œã‚‹éƒ¨åˆ†ã€æœ€å¾Œã«ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚

## Cloud NAT, Routerã®ä½œæˆ
Webã‚µãƒ¼ãƒãƒ¼ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã›ã‚‹ãŸã‚ã«ã¯NATã‹ã‚‰å¤–ã«å‡ºã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯Cloud NATã¨Cloud Routerã‚’ä½œæˆã—ã¾ã™ã€‚ã¾ãŸã¾ãŸã€ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã§ã™ã€‚

```sh compute_router.tf
resource "google_compute_router" "seoul_router" {
  name    = "seoul-router"
  region  = "asia-northeast3"
  network = google_compute_network.sample_network.id

  bgp {
    asn = 64514
  }
}
```

```sh compute_router_nat.tf
resource "google_compute_router_nat" "seoul_nat" {
  name                               = "seoul-nat"
  router                             = google_compute_router.seoul_router.name
  region                             = google_compute_router.seoul_router.region
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"
}
```

ã“ã“ã¾ã§è¨­å®šã§ããŸã‚‰ã€[æ˜¥ã®å…¥é–€ç¥­ã‚Š ğŸŒ¸ #02 Google Cloud Platform 101](https://future-architect.github.io/articles/20200602/)ã®ã€Œ6.ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¨­å®šã€ã‚’è¡Œã£ã¦ã€nginxã®ç”»é¢ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¦‹ã‚‹ã“ã¨ãŒã§ãã‚Œã°åŸºæœ¬ç·¨ã®å®Œäº†ã§ã™ï¼

# å¿œç”¨ç·¨
å¿œç”¨ç·¨ã¨ã—ã¦Teraform Cloudã®å°å…¥ã‚’è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚Terraform CloudãŒå°å…¥ã§ãã‚‹ã¨ã€Terraformã®CI/CDãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€ã‚°ãƒƒã¨é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ãŒä¸ŠãŒã‚Šã¾ã™ï¼

## Terraform Cloudã«ã¤ã„ã¦
Terraform Cloudã¯HashiCorpç¤¾ãŒæä¾›ã™ã‚‹Terraformã®CI/CDåŸºç›¤ã«ãªã‚Šã¾ã™ã€‚ãƒ—ãƒ©ãƒ³ã¯æ§˜ã€…ã‚ã‚Šã€æœ‰æ–™ç‰ˆã«ã‚ã’ã‚‹ã“ã¨ã§Policy as Code(PaC)ã‚’å®Ÿç¾ã§ãã‚‹[Sentinel](https://www.terraform.io/docs/cloud/sentinel/index.html)ã‚’å°å…¥ã§ããŸã‚Šã¨ã€ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ‡ãƒ—ãƒ­ã‚¤é€Ÿåº¦ã‚’ã‚ã’ã‚‹ä»¥å¤–ã«ã‚‚ã€Terraformã®å®Ÿè¡Œç’°å¢ƒã®çµ±ä¸€ã‚„å®Ÿè¡Œãƒ­ã‚°ã€ã‚¤ãƒ³ãƒ•ãƒ©ã®çŠ¶æ…‹ãªã©ç§©åºã‚’å®ˆã‚‹ãŸã‚ã«ã‚‚éå¸¸ã«å¤§ããªãƒ¡ãƒªãƒƒãƒˆã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚

## å¤‰æ•°ã®è¨­å®š
Terraform Cloudã«æœ¬æ ¼çš„ã«ç§»è¡Œã™ã‚‹å‰ã«ã€å¤‰æ•°ã®åˆ‡ã‚Šå‡ºã—ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ç‰¹ã«ä»Šå›ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãªã©ã‚±ã‚¢ãŒå¿…è¦ãªéƒ¨åˆ†ã‚’`secret.tfvars`ã«åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚

```sh variable.tf
variable "PROJECT_ID" {}
variable "PROJECT_NAME" {}
variable "GOOGLE_CREDENTIALS" {}
```

```sh secret.tfvars
PROJECT_ID         = "xxxxxxxx" # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥ã‚Œã‚‹
PROJECT_NAME       = "xxxxxxxx" # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥ã‚Œã‚‹
GOOGLE_CREDENTIALS = "credentials.json"
```
åˆ‡ã‚Šå‡ºã—ãŸä¸Šã‚’å…ƒã«ã•ã‚‰ã«`provider.tf`ã‚‚æ›¸ãæ›ãˆã¾ã—ã‚‡ã†ã€‚

```sh provider.tf
provider "google" {
  project     = var.PROJECT_ID
  credentials = var.GOOGLE_CREDENTIALS
}
```

## Terraform Cloudã®è¨­å®š
Terraform Cloudã¸ã®ç™»éŒ²è‡ªä½“ã¯[ã“ã¡ã‚‰]()ã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã‚‹ã®ã§ã€æ‰‹é †ã«æ²¿ã£ã¦ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚

### Workspaceã®ä½œæˆ

ç™»éŒ²ãŒå®Œäº†ã—ãŸã‚‰ã€Terraform Cloudã«ãƒªãƒã‚¸ãƒˆãƒªã®ç™»éŒ²ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—çµ‚ã‚ã£ãŸã‚ã¨ã¯ãã£ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã§ããŸã¦ãƒ›ãƒ¤ãƒ›ãƒ¤ã ã¨æ€ã„ã¾ã™ã€‚

<img src="/images/20200624/tf_cloud1.png" style="border:solid 1px #000000">

å³ã«ã‚ã‚‹[New workspace]ã‹ã‚‰æ–°ã—ã„Workspaceã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
ã¯ã˜ã‚ã«Gitãƒªãƒã‚¸ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯Githubã‚’ä½¿ç”¨ã™ã‚‹ã®ã§Githubã‚’é¸æŠã—ã¦æ¬¡ã«é€²ã¿ã¾ã™ã€‚
<img src="/images/20200624/tf_cloud2.png" style="border:solid 1px #000000">

[Choose a repository]ã®é …ç›®ã§ã¯ä»Šå›ä½¿ã†ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã—ã¾ã™ã€‚é¸æŠãŒçµ‚ã‚ã‚‹ã¨[Configure settings]ã«é€²ã‚€ã®ã§ã€Workspaceã®åå‰ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã¨ãã«å•é¡ŒãŒãªã„ã®ã§ã€ãã®ã¾ã¾(ãƒªãƒã‚¸ãƒˆãƒªã®åå‰ã®ã¾ã¾)ã§é€²ã¿ã¾ã™ã€‚

### å¤‰æ•°ã®è¨­å®š
Workspaceã®ä½œæˆãŒå®Œäº†ã™ã‚‹ã¨ã€ãã®ã¾ã¾å¤‰æ•°ã®è¨­å®šã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ãªã®ã§[Configure variables]ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚è¨­å®šã™ã‚‹ã®ã¯ã€ŒTerraform Variablesã€ã®æ–¹ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`PROJECT_ID`ã€`PROJECT_NAME`ã€`GOOGLE_CREDENTIALS`ã®3ã¤ã‚’è¨­å®šã—ã¾ã—ãŸã€‚`GOOGLE_CREDENTIALS`ã«ã¤ã„ã¦ã¯éµãªã®ã§ã€sensitiveã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨è¦‹ãˆãªããªã‚Šã¾ã™ã€‚

<img src="/images/20200624/photo_20200624_03.png" style="border:solid 1px #000000">

ã“ã‚Œã§ä¸€é€šã‚Šã®è¨­å®šãŒã§ããŸã®ã§å®Ÿéš›ã«Queueã‚’èµ°ã‚‰ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## Queueã®å®Ÿè¡Œ
ç”»é¢ã®å³ä¸Šã«[Queue plan]ã®é …ç›®ãŒã‚ã‚‹ã®ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å…¥åŠ›é …ç›®ãŒç¾ã‚Œã¾ã™ãŒã€ç‰¹ã«ä½•ã‚‚å…¥ã‚Œãšã«å®Ÿè¡Œã§ãã¾ã™ã€‚å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ã«Planã®çµæœãŒè¿”ã£ã¦ãã¾ã™ã€‚
<img src="/images/20200624/tf_cloud3.png" style="border:solid 1px #000000">

`11 to add`ã«ãªã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®Stateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¿ã¦ã„ãªã„ãŸã‚ã«èµ·ã“ã‚Šã¾ã™ã€‚ã“ã®å¾Œã§ã€Stateã®ç§»è¡Œã‚’è¡Œã„ã¾ã™ã€‚

## Tokenã‚’å–å¾—ã™ã‚‹
Terraform Cloudä¸Šã®Stateã‚’è¦‹ã‚Œã‚‹ã‚ˆã†ã«å‰ã®ä½œæ¥­ã¨ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èªè¨¼ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«å¿…è¦ãªTokenã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å–å¾—ã—ã¾ã™.

### ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†
ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦Tokenã‚’å–å¾—ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ**v0.12.21**ä»¥é™ã§ã—ã‹ä½¿ãˆãªã„ã®ã§ã€ã“ã‚Œã‚ˆã‚Šå‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ–¹ã¯GUIã‚’ä½¿ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã§å–å¾—ã—ã¦ãã ã•ã„ã€‚

```shell
$ terraform login
Terraform will request an API token for app.terraform.io using your browser.

If login is successful, Terraform will store the token in plain text in
the following file for use by subsequent commands:
    /Users/itota/.terraform.d/credentials.tfrc.json

Do you want to proceed? (y/n) y # ã“ã“ã§yã‚’å…¥åŠ›ã™ã‚‹
Terraform must now open a web browser to the tokens page for app.terraform.io.

If a browser does not open this automatically, open the following URL to proceed:
    https://app.terraform.io/app/settings/tokens?source=terraform-login


---------------------------------------------------------------------------------

Generate a token using your browser, and copy-paste it into this prompt.

Terraform will store the token in plain text in the following file
for use by subsequent commands:
    /Users/itota/.terraform.d/credentials.tfrc.json

Token for app.terraform.io: # ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã•ã‚Œã‚‹Tokenã‚’å…¥åŠ›ã™ã‚‹

Retrieved token for user xxxxxxxx


---------------------------------------------------------------------------------

Success! Terraform has obtained and saved an API token.

The new API token will be used for any future Terraform command that must make
authenticated requests to app.terraform.io.
```
ã“ã®ã‚ˆã†ã«å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€2ç®‡æ‰€å…¥åŠ›ãŒæ¸ˆã‚ã°ã“ã¡ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã¯å®Œäº†ã¨ãªã‚‹ã®ã§æ¬¡ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚

### GUIã‹ã‚‰å–å¾—ã™ã‚‹
ã“ã¡ã‚‰ã§ã¯GUIã‹ã‚‰Tokenwoå–å¾—ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ç”»åƒã«ã¤ã„ã¦é †ã‚’è¿½ã£ã¦èª¬æ˜ã—ã¾ã™ã€‚
<img src="/images/20200624/photo_20200624_04.png" style="border:solid 1px #000000">

- â‘  [Ortanization Setting]ã«é·ç§»ã™ã‚‹
- â‘¡ [API Token]ã‚’ã‚¯ãƒªãƒƒã‚¯
- â‘¢ [Create an authentication token]ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
    - Tokenåã‚’å…¥åŠ›ã™ã‚‹ã¨TokenãŒæ‰•ã„å‡ºã•ã‚Œã‚‹ã€‚

ã‚ã¨ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚Œã°Tokenã®å–å¾—ä½œæ¥­ã¯å®Œäº†ã§ã™ã€‚

```sh ~/.terraformrc
credentials "app.terraform.io" {
  token = "xxxxxxxxxxxxx" # Tokenã‚’å…¥åŠ›
}
```

## backendã®è¨­å®šã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
`backend.tf`ã‚’ä»¥ä¸‹ã«æ›¸ãæ›ãˆã¦ã€stateã‚’è¦‹ã«è¡Œãå ´æ‰€ã‚’GCSã‹ã‚‰Terraform Cloudã«å¤‰ãˆã¾ã™ã€‚

```sh backend.tf
terraform {
  backend "remote" {
    hostname = "app.terraform.io"
    organization = "kaedemalu" # ç¾åœ¨ã®Organizantion Name

    workspaces {
      name = "terraform_101" # ä½¿ã£ã¦ã„ã‚‹Workspaceã®åå‰
    }
  }
}
```
ã“ã‚Œã§å†ã³`terraform init`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ã€‚

```shell
$ terraform init
Initializing the backend...
Acquiring state lock. This may take a few moments...
Do you want to copy existing state to the new backend?
  Pre-existing state was found while migrating the previous "local" backend to the
  newly configured "remote" backend. No existing state was found in the newly
  configured "remote" backend. Do you want to copy this state to the new "remote"
  backend? Enter "yes" to copy and "no" to start with an empty state.

  Enter a value: yes # ã“ã“ã§yesã¨å…¥åŠ›ã™ã‚‹


Successfully configured the backend "remote"! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = "..." constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.google: version = "~> 3.26"

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
```

ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰Terraform Cloudã«stateãŒã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸã®ã§ã€Queue Runã®æƒ…å ±ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚Planã®è‡ªå‹•å®Ÿè¡Œçµæœã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
<img src="/images/20200624/tf_cloud4.png"  style="border:solid 1px #000000">


ãƒ­ãƒ¼ã‚«ãƒ«ã§å…¨ã¦ApplyãŒæ¸ˆã‚“ã§ã„ã‚‹ã®ã§å·®åˆ†ãŒãªã„çŠ¶æ…‹ã«ãªã‚Šã¾ã™ï¼ã¡ãªã¿ã«ã“ã®çŠ¶æ…‹ã«ãªã£ã¦ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§applyã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€

```shell
$ terraform apply

Error: Apply not allowed for workspaces with a VCS connection

A workspace that is connected to a VCS requires the VCS-driven workflow to
ensure that the VCS remains the single source of truth.
```

ã¨è¿”ã•ã‚Œã¦å®Ÿè¡Œã§ããªããªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã§Terraform Cloudã‹ã‚‰ã®ã¿ã‚³ãƒ¼ãƒ‰ã®ApplyãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€å®Ÿè¡Œç’°å¢ƒã®çµ±åˆ¶ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚
ä»Šå›ã¯Terraform 101ã¨ã„ã†ã“ã¨ã§Terraformã‚’ã¤ã‹ã£ã¦ãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰ã‚’è¡Œã„ã¾ã—ãŸã€‚ä»Šå›ã¯å–ã‚Šæ‰±ã„ã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚³ãƒ¼ãƒ‰ã®ç®¡ç†ã‚’ç’°å¢ƒã”ã¨å¤‰ãˆãšã«åˆ©ç”¨ã§ãã‚‹Workspaceã‚„Templateã¨ã—ã¦ä½¿ãˆã‚‹Moduleãªã©ã‚‚ã‚ã‚Šã¾ã™ï¼ˆå‚è€ƒè¨˜äº‹ã¯[ã“ã¡ã‚‰](https://future-architect.github.io/articles/20190903/)ã€‚ã¾ãŸã€ä»Šå›æ‰±ã£ãŸTerraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯0.12ã§ã™ãŒã€[ç’°å¢ƒæ§‹ç¯‰ç·¨](https://future-architect.github.io/articles/20190816/)ã‚„[å®Ÿè·µç·¨](https://future-architect.github.io/articles/20190819/)ã‚‚ã‚ã‚Šã¾ã™ã®ã§ãã¡ã‚‰ã‚‚ãœã²èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚
Terraformã‚’ä½¿ã†ã“ã¨ã§ä¿—ã«ã„ã†æ‰‹é †æ›¸ã‚’ç„¡ãã—ã¦ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ã“ã¨ã§å†ªç­‰æ€§ã‚’ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚ã†ã£ã‹ã‚Šæ‰‹é †ã‚’é£›ã°ã—ã¦ã€ã©ã“ã§ãƒŸã‚¹ã‚’èµ·ã“ã—ãŸã‹èª¿ã¹ã‚‹ã“ã¨ã«ã‚‚ã‹ãªã‚Šã®åŠ´åŠ›ã¨æ™‚é–“ã‚’ä½¿ã†ã¨æ€ã†ã®ã§ã€æ˜¯éTerraformã‚’æ—¥ã€…ã®(ã‚¤ãƒ³ãƒ•ãƒ©ã®)ãŠä¾›ã«å–ã‚Šå…¥ã‚Œã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ

ä»Šå›ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®Githubã«ä¸ŠãŒã£ã¦ã„ã‚‹ã®ã§ã€ãœã²å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://github.com/kaedemalu/terraform_101_handon

