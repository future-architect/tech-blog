---
title: "Pythonã«ã‚ˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é–‹ç™º"
date: 2020/08/20 00:00:00
postid: ""
tag:
  - Python
  - pytest
category:
  - Programming
thumbnail: /images/20200820/thumbnail.png
author: æ —ç”°çœŸ
lede: "æœ€è¿‘æ¥­å‹™ã§ã¯Goã‚’æ›¸ãã“ã¨ãŒå¢—ãˆã¦ãã¾ã—ãŸãŒã€ç§ã¯ä»¥å‰Pythonã‚’ã‚ˆãæ›¸ã„ã¦ã„ã¾ã—ãŸã€‚ä»Šå›ã¯Pythonã®é–‹ç™ºã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œã£ã¦ã„ãæ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚"
---
# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€‚TIG/DXãƒãƒ¼ãƒ ã®æ —ç”°ã§ã™ã€‚[å¤ä¼‘ã¿è‡ªç”±ç ”ç©¶é€£è¼‰](/articles/20200726/)14æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
æœ€è¿‘æ¥­å‹™ã§ã¯Goã‚’æ›¸ãã“ã¨ãŒå¢—ãˆã¦ãã¾ã—ãŸãŒã€ç§ã¯ä»¥å‰Pythonã‚’ã‚ˆãæ›¸ã„ã¦ã„ã¾ã—ãŸã€‚
ä»Šå›ã¯Pythonã®é–‹ç™ºã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œã£ã¦ã„ãæ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

# ã“ã®æ–‡ç« ã®ç›®çš„

æ©Ÿæ¢°å­¦ç¿’ã‚„Deep Learnigã«å¾ŒæŠ¼ã—ã•ã‚Œã€ä»Šã‚„Pythonã¯éå¸¸ã«äººæ°—ã®è¨€èªã§ã™ã€‚åˆå­¦è€…ã§ã‚‚æ‰±ã„ã‚„ã™ãã€å­¦ç”Ÿã®æ–¹ã‚‚æ•°å€¤è¨ˆç®—ã‚„ç«¶æŠ€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚ã‚‹ã„ã¯ç ”ç©¶ã§åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

ä¸€æ–¹ã§è§¦ã‚Šã‚„ã™ã„ãŒãŸã‚ã«ã€ŒPythonã¯æ›¸ã‘ã‚‹ã€ã®ã¨ã€ŒPythonã§ä½•ã‹ã‚’é–‹ç™ºã§ãã‚‹ã€ã«ã¯ã€æ„å¤–ãªã‚®ãƒ£ãƒƒãƒ—ãŒç”Ÿã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã“ã§ã¯ãã†ã„ã£ãŸã€ŒPythonã¯æ›¸ã‘ã‚‹ã—å®Ÿéš›æ›¸ã„ã¦ã„ã‚‹ã‘ã©ç‹¬å­¦ã ã£ãŸã—ã‚¢ãƒ—ãƒªã¯ä½œã£ãŸã“ã¨ãŒãªã„ã€ã‚ˆã†ãªäººã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ã€åˆå­¦è€…å‘ã‘ã«ç´¹ä»‹ã•ã‚Œã‚‹ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ã©ã®ã‚ˆã†ã«çµ„ã¿åˆã‚ã›ã¦ã„ãã‹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

# ç›®æ¬¡

- `venv` ã§é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã‚‹
- `pytest` ã‚’æ›¸ã
- `tox` ã« `pytest` ã‚’å–ã‚Šè¾¼ã‚€
- ã•ã‚‰ã« `black` ã‚„ `flake8` ã‚„ `mypy` ã‚’çµ„ã¿è¾¼ã‚“ã§ã„ã

# å‰æ

- `mypackage` ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹ã“ã¨ã¨ã—ã¾ã™

# é–‹ç™ºç’°å¢ƒã«ã¤ã„ã¦:venv

## ä»®æƒ³ç’°å¢ƒ

Pythonã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é©å®œ `pip` ã§å°å…¥å¯èƒ½ãªã®ãŒä¾¿åˆ©ã§ã™ãŒã€ãã®ã¾ã¾ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã‚·ã‚¹ãƒ†ãƒ ã«ãã®ã¾ã¾å…¥ã£ã¦ã„ãã¾ã™ã€‚

å€‹äººã§ä½œæ¥­ã™ã‚‹ã®ã§ã‚ã‚Œã°ãã‚Œã§ã‚‚å•é¡Œãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šãŒå…¥ã‚‹ã‚ˆã†ãªãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’é–‹ç™ºã—ãŸã‚Šã€ã‚ã‚‹ã„ã¯OSSãªã©ã®ã‚ˆã†ã«ãƒãƒ¼ãƒ ã§é–‹ç™ºã—ãŸã‚Šã™ã‚‹å ´åˆã¯ã€é–‹ç™ºå¯¾è±¡ã”ã¨ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

ãã®ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã®ãŒä»®æƒ³ç’°å¢ƒã§ã‚ã‚Šã€Python2.xç³»ã®ã¨ãã¯ `virtualenv` ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã® `virtualenv` ãŒPython3.3ã‹ã‚‰æ¨™æº–æ©Ÿèƒ½ã¨ã—ã¦å–ã‚Šè¾¼ã¾ã‚ŒãŸã®ãŒã€`venv` ã§ã™ã€‚

> virtualenv is a tool to create isolated Python environments. Since Python 3.3, a subset of it has been integrated into the standard library under the venv module.

[Virtualenv - virtualenv documentation](https://virtualenv.pypa.io/en/latest/)

Pythonæ¨™æº–æ©Ÿèƒ½ã®ãƒ„ãƒ¼ãƒ«ã«ãªã£ãŸã®ã§ã€ `venv` ã¯Pythonè‡ªä½“ã®versionç®¡ç†ã¯ã§ãã¾ã›ã‚“
ã¾ãŸã€Python3.3, 3.4ç³»ã§ã¯ä»®æƒ³ç’°å¢ƒã®ä½œæˆã« `pyvenv` ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã®ä»•æ§˜ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€Python3.6ç³»ã‹ã‚‰ã¯éæ¨å¥¨ã§ã™ã€‚
Python3.5ç³»ã‹ã‚‰ `venv` ãŒæ¨å¥¨ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

## venvã®ä½¿ã„æ–¹

ä»¥ä¸‹ã®å½¢ã§ä»®æƒ³ç’°å¢ƒã‚’ç”¨æ„ã—ã¾ã™ã€‚

```bash
$ cd ~/work/dir/path/mypackage
$ python -m venv .venv
$ source .venv/bin/activate
(.venv) $
```

ã“ã®ä»®æƒ³ç’°å¢ƒã‹ã‚‰æŠœã‘ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```bash
(.venv) $ deactivate
$
```

## ä»®æƒ³ç’°å¢ƒã¸ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å…ˆã«ç”¨æ„ã—ãŸä»®æƒ³ç’°å¢ƒã¯é™ã‚Šãªããƒãƒ‹ãƒ©ãªçŠ¶æ…‹ã§ã€activateå‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä½•ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€é–‹ç™ºã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ”¹ã‚ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹ãŸã‚ã«setup.pyã‚’ç”¨æ„ã™ã‚Œã°ã€`$ python setup.py install` å®Ÿè¡Œæ™‚ã«ä½œã£ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è‡ªèº«ã¨ãã‚Œã«ä¾å­˜ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ã¯é–‹ç™ºä¸­ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä»–ã®pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‘ã‚¹ã«ç§»å‹•ã™ã‚‹ã‚ˆã†ãªæ“ä½œã«ãªã‚Šã€é–‹ç™ºä¸­ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å«ã‚ã¦é€ä¸€ `$ python setup.py install` ã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚

ã§ãã‚Œã°ã€ä½œæ¥­ä¸­ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç›´æ¥å‚ç…§ã—ãŸã„ã§ã™ã€‚ãã®ãŸã‚å–ã‚‰ã‚Œã‚‹æ‰‹æ³•ã®ä¸€ã¤ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚„ã‚Šæ–¹ãŒã‚ã‚Šã¾ã™ã€‚

1. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—ã¦ç®¡ç†ï¼ˆ `requirements.txt` ãªã©ãŒãã‚Œã«è©²å½“ï¼‰
2. é–‹ç™ºå¯¾è±¡ã®ãƒ‘ã‚¹è‡ªä½“ã‚’å‚ç…§ã—ã¦ä»®æƒ³ç’°å¢ƒã§ `import` ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

`requirements.txt` ã«ã¯ä¾å­˜é–¢ä¿‚ã«ã‚ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§è¨˜è¼‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ `pip` ã® `-e` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã€ä¸Šè¨˜ã®2ã¤ã‚’æº€ãŸã—ã¾ã™ã€‚

```bash
(.venv) $ pip install -e . -r requirements.txt
```

ã“ã®æ‰‹æ³•ã‚’å–ã‚‹ã“ã¨ã§ã€è¤‡æ•°äººã«ãŠã‘ã‚‹é–‹ç™ºã§åŒã˜ç’°å¢ƒã‚’å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# Pythonã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ:pytest

## ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«æ¯”è¼ƒ

Pythonç”¨ã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¯è¤‡æ•°ã‚ã‚Šã¾ã™ã€‚

|ãƒ„ãƒ¼ãƒ«å   |èª¬æ˜                                       |
|:--------|:------------------------------------------|
|unittest |Pythonã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å«ã¾ã‚Œã‚‹ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚ |
|doctest  |ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªPythonã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¦‹ãˆã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œç´¢ã—ã€ãã‚ŒãŒæ­£ã—ã„ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚|
|nose     |unittestã‚’æ‹¡å¼µã—ã¦å®Ÿè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸ãªã©ã‚‚å–å¾—ã§ãã‚‹ã€‚|
|pytest   |ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚unittestã®å½¢ã§è¨˜è¿°ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚‚å®Ÿè¡Œã§ãã€æ‹¡å¼µæ€§ãŒé«˜ã‹ã£ãŸã‚Šãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã‚Šã™ã‚‹ã€‚ãŸã¾ã«è¦‹å—ã‘ã‚‰ã‚Œã‚‹ `py.test` ã¯å¤ã„ã‚³ãƒãƒ³ãƒ‰ã€‚|
|tox      |ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ç®¡ç†ã‚’è‡ªå‹•åŒ–ã—ã€è¤‡æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã€‚ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ„ãƒ¼ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚|

`unittest` ã‚„ `nose` ã§æ›¸ã„ãŸãƒ†ã‚¹ãƒˆãŒãã®ã¾ã¾å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ `pytest` ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚

ä¾‹ãˆã°æœ€è¿‘ã®ãƒ„ãƒ¼ãƒ«ã§ã®æ¡ç”¨ä¾‹ã¨ã—ã¦ã¯ã€AWS Glueã®ãƒ†ã‚¹ãƒˆã‚‚ `pytest` ã§è¡Œãˆã¾ã™ã€‚

ä»Šå›ã¯ã€ã“ã‚Œã« `flake8` ã‚„ `black` ã‚’çµ„ã¿åˆã‚ã›ãŸå½¢ã§ã€ `tox` ã‹ã‚‰ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚æœ‰åãª[flask](https://github.com/pallets/flask)ã‚„[sphinx](https://github.com/sphinx-doc/sphinx)ã§ã‚‚ã€ã“ã®ã‚ˆã†ãªæ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ã“ã®æ§‹æˆã‚’å®Ÿéš›ã«æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

## pytestç’°å¢ƒã®æ§‹ç¯‰

`pytest` ã®å®Ÿè¡Œã«ã¯ã€[å¼·ãæ¨å¥¨ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](https://docs.pytest.org/en/latest/goodpractices.html)ãŒã‚ã‚Šã€ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã§ã‚ã‚Œã° `pip` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–‹ç™ºã‚’ã™ã™ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã¯ãã®å½¢å¼ã«å‰‡ã‚Šã¾ã™ã€‚

```bash
.
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ setup.cfg
â”œâ”€â”€ setup.py
â”œâ”€â”€ venv
â”œâ”€â”€ src
â”‚   â””â”€â”€ mypackage
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ mypackage.py
â””â”€â”€ tests
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_mypackage.py
```

ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´ä¸‹ã« `src`

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€`test_`ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã¦ã€`tests`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«è¨­ç½®ã—ã¾ã™ã€‚ãƒ‘ã‚¹ã®é€šã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ãŸã‚‰ã€æ¬¡ã®ã‚ˆã†ãªä¸­èº«ã«ã—ã¾ã™ã€‚

```python mypackage.py
import numpy as np

def mypackage_func():
    return np.pi

def main():
    print(mypackage_func())

if __name__ == "__main__":
    main()
```

```python test_mypackage.py
from mypackage.mypackage import mypackage_func

def test_mypackage_func():
    assert "{:.2f}".format(mypackage_func()) == "3.14", "å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã¾ã§ã‚’æ¯”è¼ƒ"
    assert not mypackage_func() == 3, "å††å‘¨ç‡ã¯3ã§ã¯ãªã„"
```

ã“ã‚Œã§ `pytest` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€çµæœã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
(.venv) $ pytest
====================================== test session starts ======================================
platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1
rootdir: /home/kurita/mypackage
collected 1 item

tests/test_mypackage.py .                                                                 [100%]

======================================= 1 passed in 0.12s =======================================
```

`pytest` ã®å ´åˆ `assert` ãŒåŸºæœ¬çš„ãªä½¿ã„æ–¹ã«ãªã‚Šã¾ã™ãŒã€ã‚‚ã¡ã‚ã‚“ä»–ã®æ–¹æ³•ã‚‚ã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€ä¾‹å¤–æ¤œè¨¼ã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```python test_mypackage.py
from mypackage.mypackage import mypackage_func
import pytest

def test_mypackage_func():
    assert "{:.2f}".format(mypackage_func()) == "3.14", "å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã¾ã§ã‚’æ¯”è¼ƒ"
    assert not mypackage_func() == 3, "å††å‘¨ç‡ã¯3ã§ã¯ãªã„"

def test_zero_division():
    with pytest.raises(ZeroDivisionError):
        assert 0 == mypackage_func() / 0
```

```bash
(.venv) $ pytest -rsfp
====================================== test session starts ======================================
platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1
rootdir: /home/kurita/mypackage
collected 2 items

tests/test_mypackage.py ..                                                                [100%]

==================================== short test summary info ====================================
PASSED tests/test_mypackage.py::test_mypackage_func
PASSED tests/test_mypackage.py::test_zero_division
======================================= 2 passed in 0.12s =======================================
```

è©¦ã—ã«ã€ `pytest` å®Ÿè¡Œæ™‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦ã¿ã¾ã—ãŸã€‚å¤±æ•—ã—ãŸå†…å®¹ã‚’è‰¯ãç¢ºèªã—ãŸã‚Šã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ãŸã‚Šã§ãã¾ã™ã€‚

ä»–ã«ã‚‚ `pytest` ã«ã¯æ§˜ã€…ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

`$ pip search pytest` ã‚’å®Ÿè¡Œã™ã‚Œã°ã€ãŸãã•ã‚“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

`pytest` ã®ç´°ã‹ã„ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.pytest.org/en/stable/)ã‚’èª­ã‚“ã§ã‚‚è‰¯ã„ã§ã™ã—ã€ä¾‹ãˆã°[ã‚¨ãƒ ã‚¹ãƒªãƒ¼ã®ãƒ†ãƒƒã‚¯ãƒ–ãƒ­ã‚°](https://www.m3tech.blog/entry/pytest-summary)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

# ãƒ†ã‚¹ãƒˆç’°å¢ƒè‡ªä½“ã®æ•´ç†ï¼štox

è‡ªåˆ†ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«é–‹ç™ºã—ã¦ã„ã‚‹ã®ã ã¨ `pytest` ã§ååˆ†ã«æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Pythonã®å ´åˆã‚µãƒãƒ¼ãƒˆä¸­ã®è¨€èªãŒè¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³å­˜åœ¨ã—ã¾ã™ã€‚

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦æä¾›ã™ã‚‹ã®ã§ã‚ã‚Œã°ã€è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Pythonã§ãƒ†ã‚¹ãƒˆã—ã¦ãŠããŸã„ã§ã™ãŒã€ãã‚“ãªã¨ãã«ä½¿ãˆã‚‹ã®ãŒ[tox](https://tox.readthedocs.io/en/latest/index.html)ã§ã™ã€‚

`tox` ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ãŸå†…å®¹ã‚’ã‚‚ã¨ã«åˆ¥ã€…ã® `virtualenv` ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€å„ç’°å¢ƒã®ä¸­ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚`tox` ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã¯ `tox.ini` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

ç°¡å˜ãªä¾‹ã¨ã—ã¦ã¯ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```ini tox.ini
[tox]
# envlist: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ä¸€è¦§ã€‚ã“ã“ã§è¨˜è¼‰ã—ãŸç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚
# py37: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ python3.7 ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã—ã€ Python3.7 ã® virtualenv ã‚’ä½œæˆã—ã¾ã™
envlist = py37


# [testenv]: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®šã€‚
[testenv]

# ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®šã—ã¾ã™
# ã“ã“ã§æ¸¡ã—ãŸã‚‚ã®ãŒç›´æ¥pipã«æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€requirements.txtã®æŒ‡å®šãŒã§ãã¾ã™
# `-r` ã¨ `requirements.txt` ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
deps = -rrequirements.txt


# å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: pytest
commands = pytest -rsfp
```

```bash text
(.venv) $ tox
GLOB sdist-make: /home/kurita/mypackage/setup.py
py37 inst-nodeps: /home/kurita/mypackage/.tox/.tmp/package/1/mypackage-0.0.1.zip
py37 installed: appdirs==1.4.4,attrs==19.3.0,bleach==3.1.5,certifi==2020.6.20,cffi==1.14.1,chardet==3.0.4,colorama==0.4.3,cryptography==3.0,distlib==0.3.1,docutils==0.16,filelock==3.0.12,idna==2.10,importlib-metadata==1.7.0,iniconfig==1.0.1,jeepney==0.4.3,keyring==21.3.0,more-itertools==8.4.0,mypackage @ file:///home/hikaru/hikaru/program/mypackage/.tox/.tmp/package/1/mypackage-0.0.1.zip,mypy==0.782,mypy-extensions==0.4.3,numpy==1.19.1,packaging==20.4,pkginfo==1.5.0.1,pluggy==0.13.1,py==1.9.0,pycparser==2.20,Pygments==2.6.1,pyparsing==2.4.7,pytest==6.0.1,readme-renderer==26.0,requests==2.24.0,requests-toolbelt==0.9.1,rfc3986==1.4.0,SecretStorage==3.1.2,six==1.15.0,toml==0.10.1,tox==3.19.0,tqdm==4.48.2,twine==3.2.0,typed-ast==1.4.1,typing-extensions==3.7.4.2,urllib3==1.25.10,virtualenv==20.0.30,webencodings==0.5.1,zipp==3.1.0
py37 run-test-pre: PYTHONHASHSEED='468102422'
py37 run-test: commands[0] | pytest -rsfp
============================================= test session starts =============================================
platform linux -- Python 3.7.8, pytest-6.0.1, py-1.9.0, pluggy-0.13.1
cachedir: .tox/py37/.pytest_cache
rootdir: /home/kurita/mypackage
collected 2 items

tests/test_mypackage.py ..                                                                              [100%]

=========================================== short test summary info ===========================================
PASSED tests/test_mypackage.py::test_mypackage_func
PASSED tests/test_mypackage.py::test_zero_division
============================================== 2 passed in 0.12s ==============================================
___________________________________________________ summary ___________________________________________________
  py37: commands succeeded
  congratulations :)
```

`envlist` ã«ä»–ã®Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ä¾‹ãˆã° `py38` ã‚’è¿½åŠ ã™ã‚‹ã¨ã€python3.8ã§ã®ãƒ†ã‚¹ãƒˆã‚‚ä¸€ç·’ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼:black

ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®éš›ã«ã€Œã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã†ã‚ã‚‹ã¹ãã€ã¨ã„ã†ã®ãŒæ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚“ãªã¨ãã«å½¹ç«‹ã¤ã®ãŒã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã§ã™ã€‚ã„ã‚ãšã‚‚ãŒãªã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯èª­ã¿ã‚„ã™ãã€ã¾ãŸãŠã‹ã—ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹éƒ¨åˆ†ã‚’è¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ã€‚

Pythonã«ã‚‚ã„ãã¤ã‹ã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ãŒã‚ã‚Šã€å¤ã„ã‚‚ã®ã ã¨ `autopep8`ã€goè¨€èªã® `gofmt` ã‚’å‚è€ƒã«googleãŒä½œã£ãŸ `yapf` ãªã©ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯[black](https://github.com/psf/black)ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚Pythonã«ã¯[PEP8](https://pep8-ja.readthedocs.io/ja/latest/)ã¨ã„ã†Pythonã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ãŒã‚ã‚Šã€ã“ã‚Œã«å¾“ã†ã“ã¨ãŒåŸºæœ¬ã¨ãªã‚Šã¾ã™ã€‚

`black` ã‚‚åŸºæœ¬ã“ã®PEP8ã«æº–æ‹ ã™ã‚‹å½¢ã§ã™ãŒã€ãã®ä¸Šã§ `black` ã§å®šç¾©ã•ã‚ŒãŸå½¢ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹ã€ã„ã‚ã°ã‚ˆã‚Šåˆ¶ç´„ã®å¼·ã„PEP8ã®ã‚ˆã†ãªæŒ¯ã‚‹èˆã„ã‚’ã—ã¾ã™ã€‚`black` ã®ã•ã‚‰ãªã‚‹ç‰¹å¾´ã¨ã—ã¦ã¯ã€ä¸Šè¿°ã®2ã¤ã®ãƒ„ãƒ¼ãƒ«ã«æ¯”ã¹ã¦è‡ªç”±åº¦ãŒå°‘ãªã„ã“ã¨ã§ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šã®ä½™åœ°ãŒå°‘ãªã„ã“ã¨ã‹ã‚‰é–‹ç™ºè€…ã®å¥½ã¿ã«ã‚ˆã£ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒèµ·ãã¥ã‚‰ãã€è¦‹ãŸç›®ãŒæƒã„ã‚„ã™ã„ã§ã™ã€‚PyConJPãªã©å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã®å…¥é–€è€…ç”¨ã®ç™ºè¡¨ã§ã‚‚ã€åˆ©ç”¨ã‚’æ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

## blackã®å®Ÿè¡Œ

`pip` ã§ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã®ã§ã€è©¦ã—ã¦ã¿ã¾ã™ã€‚
`black` ã‚³ãƒãƒ³ãƒ‰ã ã‘ã ã¨å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‹ã‘ã¦æ›¸ãç›´ã—ã¾ã™ãŒã€`--check` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒã‹ã‹ã‚‹å¯¾è±¡ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```bash
(.venv) $ pip install black
(.venv) $ $ black . --check
All done! âœ¨ ğŸ° âœ¨
5 files would be left unchanged.
```

ç‰¹æ®µã‚¨ãƒ©ãƒ¼ãŒç„¡ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ä½™è«‡ã§ã™ãŒã€ `black` ã®æ•°å°‘ãªã„è¨­å®šã¨ã—ã¦ã€é™¤å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šãŒã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚ã€ã‚ˆãã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã¯excludeã•ã‚Œã¦ã„ã¾ã™ã€‚

```bash
(.venv) $ black --help
...ä¸­ç•¥...
  --exclude TEXT                  A regular expression that matches files and
                                  directories that should be excluded on
                                  recursive searches.  An empty value means no
                                  paths are excluded. Use forward slashes for
                                  directories on all platforms (Windows, too).
                                  Exclusions are calculated first, inclusions
                                  later.  [default: /(\.eggs|\.git|\.hg|\.mypy
                                  _cache|\.nox|\.tox|\.venv|\.svn|_build|buck-
                                  out|build|dist)/]
...ä»¥ä¸‹ç•¥...
```

ãƒ˜ãƒ«ãƒ—ã«ã‹ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ `.tox` ã‚„ `.venv` ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦ã¯ã€æœ€åˆã‹ã‚‰ `black` ã®å¯¾è±¡å¤–ã«ã•ã‚Œã¦ã„ã¾ã™ã€‚

è©¦ã—ã«ãã®ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ `black` ã‚’ã‹ã‘ã¦è¦‹ãˆã‚‹ã¨ã€reformatãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```bash
(.venv) $ black .venv/bin/rst2odt.py --check
would reformat .venv/bin/rst2odt.py
Oh no! ğŸ’¥ ğŸ’” ğŸ’¥
1 file would be reformatted.
```

`.tox` ã‚„ `.venv` ã¨ã‚‚ã« `.gitignore` ã«è¨˜è¼‰ã•ã‚Œã‚‹ã‚ˆã†ãªå¯¾è±¡ã§ã™ã®ã§ã€ `black` ã§ç®¡ç†ã™ã‚‹å¿…è¦ã‚‚ãªã„ã§ã—ã‚‡ã†ã€‚
ã¡ãªã¿ã«é–‹ç™ºç’°å¢ƒã«ã‚ˆã£ã¦ä»–ã®é™¤å¤–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ãŸã„å ´åˆã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ `pyproject.toml` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã§ã€ã¾ã¨ã‚ã¦å¤–ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

## toxã¸ã®å–ã‚Šè¾¼ã¿

`black` ã«ã‚ˆã£ã¦ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã®ã§ã€ã“ã‚Œã‚’toxã«ã‚‚çµ„ã¿è¾¼ã¿ã¾ã™ã€‚

ã¨ã„ã£ã¦ã‚‚ã€ `tox.ini` ã‚’æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã ã‘ã§ã™ã€‚ã“ã‚Œã§ã€ `tox` ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« `black` ã‚’ã‹ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ini tox.ini
[tox]
# envlist: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ä¸€è¦§ã€‚ã“ã“ã§è¨˜è¼‰ã—ãŸç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚
# py37: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ python3.7 ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã—ã€ Python3.7 ã® virtualenv ã‚’ä½œæˆã—ã¾ã™
envlist = py37, black


# [testenv]: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®šã€‚
[testenv]

# ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®šã—ã¾ã™
# ã“ã“ã§æ¸¡ã—ãŸã‚‚ã®ãŒç›´æ¥pipã«æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€requirements.txtã®æŒ‡å®šãŒã§ãã¾ã™
# `-r` ã¨ `requirements.txt` ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
deps = -rrequirements.txt


# å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: pytest
commands = pytest -rsfp

# blackç”¨ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã€‚æŒ‡å®šãŒãªã‘ã‚Œã°testenvç’°å¢ƒãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
[testenv:black]
basepython = python3.7
deps = black
commands = black . --check
```

depsã«ã¤ã„ã¦ã¯ `-rrequirements.txt` ã§æŒ‡å®šã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¯å›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§çœã„ã¦ã€å¿…è¦æœ€å°é™ã«ã—ã¦ã„ã¾ã™ã€‚

# æ–‡æ³•ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«:flake8

`flake8` ã¯é™çš„æ–‡æ³•ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«ã§ã€ã“ã‚Œã‚‚PEP8ã«å¾“ã†å½¢ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒã‚°ã«ãªã‚Šã‚„ã™ã„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¾ã™ã€‚

## flake8ã®å®Ÿè¡Œ

ã“ã‚Œã‚‚ `pip` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```bash
(.venv) $ pip install flake8
(.venv) $ flake8 src/
src/mypackage/mypackage.py:7:1: E302 expected 2 blank lines, found 1
```

ãªã«ã‹è¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€ã“ã‚Œã¯ `é–¢æ•°ã®å‰ã«ã¯2è¡Œã®blank lineãŒå¿…è¦ãªã®ã«1è¡Œã—ã‹ãªã„ã‚ˆ` ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```python src/mypackage/mypackage.py
import numpy as np


def mypackage_func():
    return np.pi

def main():
    print(mypackage_func())


if __name__ == "__main__":
    main()
```

ç¢ºã‹ã«ã€ `def main():` ã®å‰ã«1è¡Œã—ã‹blank lineãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ãªã®ã§ã€1è¡ŒåŠ ãˆã¦ã¿ã¾ã™ã€‚

```python src/mypackage/mypackage.py
import numpy as np


def mypackage_func():
    return np.pi


def main():
    print(mypackage_func())


if __name__ == "__main__":
    main()
```

```bash
(.venv) $ flake8 src/
(.venv) $
```

å…ˆç¨‹ã®E302ã®è¡¨ç¤ºãŒæ¶ˆãˆã¾ã—ãŸã€‚

## flake8ã®toxã¸ã®çµ„ã¿è¾¼ã¿

`flake8` ã‚‚ `tox` ã«çµ„ã¿è¾¼ã‚“ã§ã€è‡ªå‹•åŒ–ã—ã¾ã—ã‚‡ã†ã€‚
ã“ã‚Œã‚‚ `tox.ini` ã®ä¸­ã«è¨˜è¼‰ã—ã¾ã™ã€‚

```ini tox.ini
[tox]
# envlist: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ä¸€è¦§ã€‚ã“ã“ã§è¨˜è¼‰ã—ãŸç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚
# py37: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ python3.7 ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã—ã€ Python3.7 ã® virtualenv ã‚’ä½œæˆã—ã¾ã™
envlist = py37, black, flake8


# [testenv]: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®šã€‚
[testenv]

# ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®šã—ã¾ã™
# ã“ã“ã§æ¸¡ã—ãŸã‚‚ã®ãŒç›´æ¥pipã«æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€requirements.txtã®æŒ‡å®šãŒã§ãã¾ã™
# `-r` ã¨ `requirements.txt` ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
deps = -rrequirements.txt


# å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: pytest
commands = pytest -rsfp

# blackç”¨ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã€‚æŒ‡å®šãŒãªã‘ã‚Œã°testenvç’°å¢ƒãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
[testenv:black]
basepython = python3.7
deps = black
commands = black . --check

[testenv:flake8]
deps = flake8
commands = flake8 .

[flake8]
max-line-length = 88
ignore = E203, W503, W504
exclude = .git, __pychache__, build, dist, .tox, .venv
```

å…ˆã« `black` ã‚’å°å…¥ã—ã¦ã„ã¾ã™ãŒã€ `flake8` ã¨ `black` ã¯ä½µç”¨å¯èƒ½ã§ã™ã€‚ãŸã ã—ã€ä¸€éƒ¨éäº’æ›ã®éƒ¨åˆ†ãŒã‚ã‚‹ã®ã§ã€2ç®‡æ‰€ä¿®æ­£ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚

ä¸€ã¤ã¯ `max-line-length` ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ `black` å´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§88æ–‡å­—ãªã®ã§ã€ãã‚Œã«åˆã‚ã›ã¾ã™ã€‚ã‚‚ã—ã‚‚blackå´ã§å¤‰æ›´ã‚’å…¥ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã«åˆã‚ã›ã‚‹å½¢ã§ä¿®æ­£ã—ã¾ã™ã€‚ã‚‚ã†ä¸€ã¤ãŒã€E203, W503, W504ã§ã™ã€‚ã“ã¡ã‚‰ã‚‚ `black` å´ã§è¨±å®¹ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ignoreã«ã—ã¾ã™ã€‚

æœ€å¾Œã«ã€é–‹ç™ºç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã«ã™ã‚‹ã¨å¤§å¤‰ãªã®ã§ã€ãã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’excludeã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `.git` ãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ãŒã€ `.tox` ã‚„ `.venv` ãŒå«ã¾ã‚Œã¦ã„ãªã„ã®ã§ã€ã“ã“ã§æ˜ç¤ºçš„ã«è¨­å®šã—ã¾ã™ã€‚ãªãŠã€ `build` ã‚„ `dist` ã¯ `setup.py` ã‚’ä½¿ã†ã¨ãã«å°†æ¥çš„ã«å¿…è¦ã«ãªã‚‹ã“ã¨ã‚’è¦‹è¶Šã—ã¦å…¥ã‚Œã¦ã„ã¾ã™ã€‚

# é™çš„è§£æãƒ„ãƒ¼ãƒ«:mypy

Python3.5ã‹ã‚‰å‹ãƒ’ãƒ³ãƒˆãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ã“ã‚Œã¯Pythonã«å¤‰æ•°ã®å‹ãƒã‚§ãƒƒã‚¯ã‚’ã‚‚ãŸã‚‰ã—ã¾ã—ãŸã€‚

ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸã ã‘ã§ãã®å¤‰æ•°ã«ã©ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹ã‚„å‹ã®å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ã‚ãã¾ã§ãƒ’ãƒ³ãƒˆã§ã‚ã£ã¦å®Ÿè¡Œæ™‚ã«ã¯å½¹ã«ã¯ç«‹ã¡ã¾ã›ã‚“ã€‚ã“ã®å‹ã‚’é™çš„ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ„ãƒ¼ãƒ«ãŒã€[mypy](https://mypy.readthedocs.io/en/stable/index.html)ã§ã™ã€‚

## mypyã®å®Ÿè¡Œ

`pip` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦è©¦ã—ã¦ã¿ã¾ã™ã€‚

```bash
(.venv) $ pip install mypy
```

mypyã®ä½¿ã„æ–¹ã¯ã€å¼•æ•°ã®å³å´ã« `: å‹å` ã¨ã€é–¢æ•°ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã®å³å´ã« ` -> å‹å` ã¨ã¤ã‘ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è¡Œã„ã¾ã™ã€‚
è©¦ã—ã«ã€ ã“ã‚Œã¾ã§ä½œã£ã¦ã„ãŸ `src/mypackage/mypackage.py` ã«mypyã‚’ã‹ã‘ã¦ã¿ã¾ã™ã€‚

```python src/mypackage/mypackage.py
import numpy as np


def mypackage_func():
    return np.pi


def main():
    print(mypackage_func())


if __name__ == "__main__":
    main()

```

```bash
(.venv) $ mypy  src/mypackage/mypackage.py
src/mypackage/mypackage.py:1: error: Skipping analyzing 'numpy': found module but no type hints or library stubs
src/mypackage/mypackage.py:1: note: See https://mypy.readthedocs.io/en/latest/running_mypy.html#missing-imports
Found 1 error in 1 file (checked 1 source file)
```

`numpy` ãŒãªã«ã‹å¼•ã£ã‹ã‹ã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã¯ã€ `mypy` ãŒã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯Stubãƒ•ã‚¡ã‚¤ãƒ«ã¨ã„ã†å‹ãƒ’ãƒ³ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãƒã‚§ãƒƒã‚¯ã‚’ã‹ã‘ã‚‹ã®ã§ã™ãŒã€ç¾åœ¨ã®ç’°å¢ƒã«ã¯ãã‚ŒãŒãªã„ãŸã‚æ€’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
Stubãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚ˆãã‚„ã‚‹æ‰‹æ³•ã¨ã—ã¦ã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹ãƒ’ãƒ³ãƒˆã‚’ç„¡è¦–ã™ã‚‹ã“ã¨ã‚’ã—ã¾ã™ã€‚
ã“ã‚Œã«ã¯ã€ `mypy` ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ `mypy.ini` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```ini mypy.ini
[mypy]

[mypy-numpy]
ignore_missing_imports = True
```

```bash
(.venv) $ mypy src/mypackage/mypackage.py
Success: no issues found in 1 source file
```

ã“ã‚Œã§ `numpy` ã®å‹ãƒ’ãƒ³ãƒˆã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸã€‚
ç¶šã„ã¦ã€ `src/mypackage/mypackage.py` ã«å¯¾ã—ã¦å‹ãƒ’ãƒ³ãƒˆã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```python src/mypackage/mypackage.py
import numpy as np


def mypackage_func():
    return np.pi


def mypy_func(x: int) -> None:
    print("This is mypy test: x = {}".format(x))
    return


def main():
    print(mypackage_func())


if __name__ == "__main__":
    main()
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã« `mypy` ã‚’ã‹ã‘ã¦ã‚‚ã€ç‰¹ã«ã‚¨ãƒ©ãƒ¼ã¯ã§ã¾ã›ã‚“ã€‚
ç¶šã„ã¦ã€ã‚ã–ã¨ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ã›ã¦ã¿ã¾ã™ã€‚

```python src/mypackage/mypackage.py
...å‰ç•¥...
def mypy_func(x: int) -> str: # ãƒªã‚¿ãƒ¼ãƒ³ã‚’None->strã«å¤‰ãˆãŸ
    print("This is mypy test: x = {}".format(x))
    return
...ä»¥ä¸‹ç•¥...
```

```bash
$ mypy src/mypackage/mypackage.py
src/mypackage/mypackage.py:10: error: Return value expected
Found 1 error in 1 file (checked 1 source file)
```

ç¢ºã‹ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚
ã•ã‚‰ã«ã€ `mypackage_func()` ã®æ–¹ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ã›ã¦ã¿ã¾ã™ã€‚

```python src/mypackage/mypackage.py
...å‰ç•¥...
def mypackage_func() -> None:
    return np.pi
...ä»¥ä¸‹ç•¥...
```

```bash
$ mypy src/mypackage/mypackage.py
src/mypackage/mypackage.py:10: error: Return value expected
Found 1 error in 1 file (checked 1 source file)
```

`np.pi` ã¯ `float` ãªã®ã§æ˜ã‚‰ã‹ã«é–“é•ã£ã¦ã„ã¾ã™ãŒã€ `mypy` ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã¾ã›ã‚“ã€‚
ä»Šå› `numpy` ã¯ignoreã«ã™ã‚‹å¯¾è±¡ã¨ã—ã¦ã„ã¾ã™ã®ã§ã€ä»Šå›ã®ãƒã‚§ãƒƒã‚¯å¤–ã¨ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã¡ã‚‰ã§ã™ãŒã€æ˜ç¤ºçš„ã«å‹æŒ‡å®šã™ã‚‹ã¨ã€ `mypy` ã§ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã§ãã¾ã™ã€‚

```python src/mypackage/mypackage.py
...å‰ç•¥...
def mypackage_func() -> None:
    return float(np.pi) # floatã§æ˜ç¤ºçš„ã«ã‚­ãƒ£ã‚¹ãƒˆã—ãŸ
...ä»¥ä¸‹ç•¥...
```

```bash
(.venv) $ mypy src/mypackage/mypackage.py
src/mypackage/mypackage.py:5: error: No return value expected
src/mypackage/mypackage.py:10: error: Return value expected
Found 2 errors in 1 file (checked 1 source file)
```

## toxã¸ã®mypyã®çµ„ã¿è¾¼ã¿

æœ€å¾Œã«ã€ã€€`mypy` ã‚‚ `tox.ini` ã«è¿½åŠ ã—ã¾ã™ã€‚

```ini tox.ini
[tox]
# envlist: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ä¸€è¦§ã€‚ã“ã“ã§è¨˜è¼‰ã—ãŸç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚
# py37: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ python3.7 ã‚³ãƒãƒ³ãƒ‰ã‚’æ¢ã—ã€ Python3.7 ã® virtualenv ã‚’ä½œæˆã—ã¾ã™
envlist = py37, black, flake8, mypy


# [testenv]: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®šã€‚
[testenv]

# ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®šã—ã¾ã™
# ã“ã“ã§æ¸¡ã—ãŸã‚‚ã®ãŒç›´æ¥pipã«æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€requirements.txtã®æŒ‡å®šãŒã§ãã¾ã™
# `-r` ã¨ `requirements.txt` ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
deps = -rrequirements.txt


# å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰: pytest
commands = pytest -rsfp

# blackç”¨ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã€‚æŒ‡å®šãŒãªã‘ã‚Œã°testenvç’°å¢ƒãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
[testenv:black]
basepython = python3.7
deps = black
commands = black . --check

[testenv:flake8]
deps = flake8
commands = flake8 .

[flake8]
max-line-length = 88
ignore = E203, W503, W504
exclude = .git, __pychache__, build, dist, .tox, .venv

[testenv:mypy]
deps = mypy
commands = mypy src
```

ç„¡äº‹ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚

```bash
(.venv) $ tox
...ä¸­ç•¥...
_______________________________ summary ________________________________
  py37: commands succeeded
  black: commands succeeded
  flake8: commands succeeded
  mypy: commands succeeded
  congratulations :)
```

# è£œè¶³ï¼šVSCodeã«ãŠã‘ã‚‹blackã¨flake8ã¨mypyã‚’å–ã‚Šè¾¼ã‚€

ä»Šå›ç´¹ä»‹ã—ãŸãƒ„ãƒ¼ãƒ«ã¯éƒ½åº¦ã‹ã‘ã‚Œã°ãã‚Œã„ãªã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ã¾ã™ãŒã€é€æ¬¡æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚
ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ°—ã¥ã‘ã‚‹ã¨ã„ã£ã¦ã‚‚ã€ã§ãã‚Œã°ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã«è‡ªå‹•æ•´å½¢ã—ã¦ã»ã—ã„ã—ã€é©å®œæŒ‡æ‘˜ã—ã¦ã»ã—ã„ã®ã§ã€ãã®ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

## Pythonç”¨Extensionã®å°å…¥

ã‚ã¾ã‚Šè¨€ã†ã¾ã§ã‚‚ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ `Python ms-python.python` ã‚’å°å…¥ã—ã€æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

<img src="/images/20200820/image.png" loading="lazy">

## setting.jsonã®è¨˜è¿°

File->Preference->Settingsã¨é–‹ãã¾ã™ã€‚

<img src="/images/20200820/ç„¡é¡Œ.png" loading="lazy">

Workspaceã‚’é¸æŠã—ã€ `settings.json` ã‚’é–‹ãã¾ã™ã€‚

<img src="/images/20200820/ç„¡é¡Œ2.png" loading="lazy">

æ¬¡ã®ã‚ˆã†ãªæ„Ÿã˜ã§è¨˜è¼‰ã—ã¾ã™ã€‚

```json settings.json
{
    // pythonã®ç’°å¢ƒè¨­å®š
    "python.pythonPath": ".venv/bin/python",
    "python.venvPath": ".venv",
    // Linterã®è¨­å®š
    "python.linting.pylintEnabled": false,
    "python.linting.flake8Enabled": true,
    "python.linting.mypyEnabled": true,
    "python.linting.lintOnSave": true,
    "python.linting.flake8Args": [
      "--max-line-length",
      "88",
      "--ignore=E203,W503,W504"
    ],
    // Formatterã®è¨­å®š
    "python.formatting.provider": "black",
    "editor.formatOnSave": true,
    "editor.formatOnPaste": false
  }
```

ã‚ã¨ã¯ã€VSCodeã‚’Reloadï¼ˆå†èµ·å‹•ï¼‰ã—ã¦ãã ã•ã„ã€‚
ã“ã‚Œã§ã€é–‹ç™ºä¸­ã« `black`, `flake8`, `mypy` ãŒå‹•ä½œã—ã¾ã™ã€‚

# æœ€å¾Œã«

ã“ã“ã¾ã§ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://github.com/montblanc18/mypackage)ã§å…¬é–‹ã—ã¦ã„ã¾ã™ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã”è¦§ãã ã•ã„ã€‚

è‡ªä½œã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’PyPIã«ç™»éŒ²ã™ã‚‹ã“ã¨ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ `setup.py` ã§å›ºã‚ã¦ `twine` ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãªã©ã®å·¥ç¨‹ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ãã‚Œã‚‰ã®ã‚„ã‚Šæ–¹ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã§ã„ã‚ã„ã‚ãªæ–¹ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚

ã¾ãŸã€ã“ã‚Œã§ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã®ã§ã€ä¾‹ãˆã°CircleCIãªã©ã«ä¹—ã›ã¦è‡ªå‹•ãƒ†ã‚¹ãƒˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
