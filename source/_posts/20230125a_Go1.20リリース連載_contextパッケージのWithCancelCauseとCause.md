---
title: "Go1.20ãƒªãƒªãƒ¼ã‚¹é€£è¼‰ contextãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®WithCancelCauseã¨Cause"
date: 2023/01/25 00:00:00
postid: a
tag:
  - Go
  - Go1.20
category:
  - Programming
thumbnail: /images/20230125a/thumbnail.png
author: çœŸé‡éš¼è¨˜
lede: "Go 1.20ãƒªãƒªãƒ¼ã‚¹é€£è¼‰ã®2æœ¬ç›®ã¯context ã«ã¤ã„ã¦ã§ã™ã€‚Go 1.7ã§ `context.Context`ãŒå…¥ã£ã¦ã‹ã‚‰ã€contextç•Œéšˆã«ãŠã„ã¦ä¹…ã—ã¶ã‚Šã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã™ã€‚"
---

<img src="/images/20230125a/top.png" alt="" width="800" height="433">

# ã¯ã˜ã‚ã«

TIGçœŸé‡ã§ã™ã€‚[Go 1.20ãƒªãƒªãƒ¼ã‚¹é€£è¼‰](/articles/20230123a/)ã®2æœ¬ç›®ã¯ã€[Minor changes to the library](https://tip.golang.org/doc/go1.20#minor_library_changes)ã® context ã«ã¤ã„ã¦ã§ã™ã€‚Go 1.7ã§ `context.Context`ãŒå…¥ã£ã¦ã‹ã‚‰ã€contextç•Œéšˆã«ãŠã„ã¦ä¹…ã—ã¶ã‚Šã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã™ã€‚

contextã®æ­´å²ã‚„ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã¯ã€æ¾å·ã•ã‚“ã®[Go 1.16ã®signal.NotifyContext() ](https://future-architect.github.io/articles/20210212/) è¨˜äº‹ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã®ã§ã€ãœã²ç¢ºèªãã ã•ã„ã€‚contextè‡ªä½“ã«ã®èª¬æ˜ã¯ã€ã•ã(H.Saki)ã•ã‚“ã® [ã‚ˆãã‚ã‹ã‚‹contextã®ä½¿ã„æ–¹ ](https://zenn.dev/hsaki/books/golang-context)ã¨ã„ã†Zenn Bookã‚’èª­ã‚€ã¨ã™ã”ãè©³ã—ããªã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«ã¯ã€`WithCancelCause()`ã¨ `Cause()` é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’è¿½åŠ ãƒ»å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†å†…å®¹ã§ã™ã€‚ãªãœã‹2023.1.22æ™‚ç‚¹(go 1.20rc3)ã ã¨GoDocã«ã¯`WithDeadlineCause()`ãƒ»`WithTimeoutCause()` ãŒã‚ã‚‹ã‚‚ã®ã®å®Ÿè£…ã¯ç„¡ãã€[context: add APIs for writing and reading cancelation cause #51365](https://github.com/golang/go/issues/56661) ã‚’è¦‹ã‚‹é™ã‚Šã€Go 1.21ã§è¿½åŠ ã•ã‚Œãã†ã§ã™ã€‚

> **Go 1.20ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚ˆã‚Šï¼ˆ2023.1.22 DRAFT RELEASE NOTESã‚ˆã‚Šï¼‰**
> The new WithCancelCause function provides a way to cancel a context with a given error. That error can be retrieved by calling the new Cause function.
> æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸWithCancelCauseé–¢æ•°ã¯errorä»˜ãã§contextã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹æ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚errorã¯æ–°ã—ãè¿½åŠ ã—ãŸCauseé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§å–å¾—ã§ãã¾ã™ã€‚

GoDocã®contextãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®[func WithCancelCause](https://pkg.go.dev/context@master#WithCancelCause)ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚‚æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

```go GoDocã®WithCancelCauseã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆgo 1.20rc3æ™‚ç‚¹ãªã®ã§è’ã„ï¼‰
ctx, cancel := context.WithCancelCause(parent)
cancel(myError)
ctx.Err() // returns context.Canceled
context.Cause(ctx) // returns myError
```

ãƒ„ã‚¤ãƒ¼ãƒˆã§ç™ºè¡¨ã•ã‚ŒãŸéš›ã®åå¿œã‚’è¦‹ã‚‹ã¨ã€å–œã³ã®å£°ãŒå¤šæ•°ã§ã—ãŸã€‚

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Probably in Go 1.20:<br><br>context.WithCancelCause ğŸ‰<br><br>ctx.Err() will return why a context is canceled if that context is derived with a cancel cause. Instead of mere `Canceled` and `DeadlineExceeded` errors.<br><br>Proposal â†’ <a href="https://t.co/H1jMbp5HGM">https://t.co/H1jMbp5HGM</a><a href="https://twitter.com/hashtag/golang?src=hash&amp;ref_src=twsrc%5Etfw">#golang</a> <a href="https://t.co/bRFFXB1DFx">pic.twitter.com/bRFFXB1DFx</a></p>&mdash; inanc (@inancgumus) <a href="https://twitter.com/inancgumus/status/1599073261169430528?ref_src=twsrc%5Etfw">December 3, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


ãƒ—ãƒ­ãƒãƒ¼ã‚µãƒ«ã¯[context: add APIs for writing and reading cancelation cause #51365](https://github.com/golang/go/issues/51365) ã§ã™ã€‚èµ·ç¥¨ãŒ2022.2.26ã§ã™ã®ã§ã€ã“ã‚Œã ã‘è¦‹ã‚Œã°10ãƒ¶æœˆã»ã©ã§å…¥ã£ãŸã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚å®Ÿéš›ã¯ãã‚Œä»¥å‰ã«ã‚‚ä¼¼ãŸã‚ˆã†ãªè­°è«–ãŒã‚ã‚Šã€ä¾‹ãˆã°[context: ease debugging of where a context was canceled? #26356](https://github.com/golang/go/issues/26356) ã¯2018å¹´ã«ã€[proposal: context: add WithCancelReason #46273](https://github.com/golang/go/issues/46273)ã¯2021å¹´ã«èµ·ç¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚#26356ã‚„#46273ã«ã¦æ¡ä»¶ã€å¯¾å¿œæ¡ˆã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®å®Ÿè£…ãªã©ãŒæ•´ç†ã•ã‚ŒãŸã“ã¨ãŒã‚ã£ã¦ã“ãå®Ÿç¾ã§ããŸã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚


## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã©ã“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ãƒ‡ãƒãƒƒã‚¯é›£ã—ã„å•é¡Œ

Go 1.20ã‚ˆã‚Šå‰ã®æ™‚ä»£ã§ã¯ã€contextã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ã‚ˆãä¸ŠãŒã‚‹èª²é¡Œã«ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒã©ã“ã§è¡Œã‚ã‚ŒãŸã‹åˆ‡ã‚Šåˆ†ã‘ã—ã«ãã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã€ŒWho the hell canceled my context?ï¼ˆã ã‚ŒãŒç§ã®contextã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‹ï¼Ÿï¼‰ã€ã¨å†—è«‡æ··ã˜ã‚Šã§ã®æ‚©ã¿ã‚’ã¡ã‚‡ãã¡ã‚‡ãèãã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ã«å¤šæ®µã«contextã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã™ã‚‹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚ä»®ã«ä¸€ç•ªä¸‹æµã® `callHeavyWebAPI()` é–¢æ•°ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ãŸã„ã¨ã—ã¾ã™ã€‚

```go Go1.19ä»¥å‰ã§ã®å®Ÿè£…ä¾‹
package main

import (
	"context"
	"fmt"
	"time"
)

func main() {
	ctx, cancel := context.WithCancel(context.Background())
	time.AfterFunc(10*time.Second, func() { cancel() }) // å…¨ä½“ã§10ç§’ã¾ã§
	// ... ä½•ã‹ã—ã‚‰ã®å‰å‡¦ç†ãªã©
	go doHeavyTask(ctx)
	// ...
}

func doHeavyTask(ctx context.Context) {
	ctx, cancel := context.WithCancel(ctx)
	time.AfterFunc(5*time.Second, func() { cancel() }) // doHeavyTaské–¢æ•°ã§æœ€å¤§5ç§’ã¾ã§
	// ... ä½•ã‹ã—ã‚‰ã®å‡¦ç†
	callHeavyWebAPI(ctx)
	// ... ä½•ã‹ã—ã‚‰ã®å‡¦ç†
}

func callHeavyWebAPI(ctx context.Context) {
	ctx, cancel := context.WithCancel(ctx)
	time.AfterFunc(3*time.Second, func() { cancel() }) // callHeavyWebAPIé–¢æ•°ã§æœ€å¤§3ç§’ã¾ã§

	for {
		select {
		case <-ctx.Done():
			switch ctx.Err() {
			case context.DeadlineExceeded:
				fmt.Println("context timeout exceeded")
			case context.Canceled:
				fmt.Println("context canceled") // â˜…ã©ã“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸï¼ŸğŸ˜­
			}
			return
		default:
			// ...å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã©ã®å‡¦ç†
		}
	}
}
```

æœ€å¾Œã®`select` ã®éƒ¨åˆ†ã®å®Ÿè£…ã®ã‚ˆã†ã«ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‹ã¯ `ctx.Err()` ã‚’è¦‹ã‚‹ã“ã¨ã§åˆ¤æ–­ã§ãã¾ã™ã€‚ã—ã‹ã—ã€`main()`, `doHeavyTask()`, `callHeavyWebAPI()` é–¢æ•°ãã‚Œãã‚Œã§è¨­å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã©ã‚ŒãŒç›´æ¥ã®åŸå› ã‹ã¯åˆ¤æ–­ãŒä»˜ãã¾ã›ã‚“ã€‚

å›é¿æ–¹æ³•ã¨ã—ã¦ã¯ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’é€£æºã™ã‚‹ãŸã‚ã® `channel` ã‚’å¼•ãå›ã™ã“ã¨ã‚’æ¤œè¨ã™ã‚‹ãªã©ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€ã‘ã£ã“ã†å¤§å¤‰ãã†ã§ã™ã€‚


## contextãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«WithCancelCauseã¨Causeã‚’è¿½åŠ 

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€`context.WithCancelCause()`ã¨ `Cause()` é–¢æ•°ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚`context.WithCancelCause()`ã¯ã»ã¼ `WithCancel()`ã¨ä½¿ã„å‹æ‰‹ãŒåŒã˜ã§ã™ãŒã€`CancelCauseFunc(cause error)` ã¨å¼•æ•°ã« `cause`ã‚’å–ã‚‹éƒ¨åˆ†ãŒç•°ãªã‚Šã¾ã™ã€‚ã“ã“ã« `error` ã‚’æ¸¡ã™ã¨ä½•ãŒç†ç”±ã§`context`ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹åˆ†ã‹ã‚Šã¾ã™ã€‚

```diff Go1.20ä»¥é™ã®å®Ÿè£…ä¾‹
package main

import (
	"context"
	"errors"
	"fmt"
	"time"
)

+var (
+	ErrTimeoutOuter  = errors.New("outer timeout")
+	ErrTimeoutMiddle = errors.New("middle timeout")
+	ErrTimeoutInner  = errors.New("inner timeout")
+)

func main() {
	ctx, cancel := context.WithCancelCause(context.Background())
-	time.AfterFunc(10*time.Second, func() { cancel() }) // å…¨ä½“ã§10ç§’ã¾ã§
+	time.AfterFunc(10*time.Second, func() { cancel(ErrTimeoutOuter) }) // å…¨ä½“ã§10ç§’ã¾ã§
	// ... ä½•ã‹ã—ã‚‰ã®å‰å‡¦ç†ãªã©
	go doHeavyTask(ctx)
	// ...
}

func doHeavyTask(ctx context.Context) {
	ctx, cancel := context.WithCancelCause(ctx)
-	time.AfterFunc(5*time.Second, func() { cancel() }) // doHeavyTaské–¢æ•°ã§æœ€å¤§5ç§’ã¾ã§
+	time.AfterFunc(5*time.Second, func() { cancel(ErrTimeoutMiddle) }) // doHeavyTaské–¢æ•°ã§æœ€å¤§5ç§’ã¾ã§
	// ... ä½•ã‹ã—ã‚‰ã®å‡¦ç†
	callHeavyWebAPI(ctx)
	// ... ä½•ã‹ã—ã‚‰ã®å‡¦ç†
}

func callHeavyWebAPI(ctx context.Context) {
	ctx, cancel := context.WithCancelCause(ctx)
-	time.AfterFunc(3*time.Second, func() { cancel() }) // callHeavyWebAPIé–¢æ•°ã§æœ€å¤§3ç§’ã¾ã§
+	time.AfterFunc(3*time.Second, func() { cancel(ErrTimeoutInner) }) // callHeavyWebAPIé–¢æ•°ã§æœ€å¤§3ç§’ã¾ã§

	for {
		select {
		case <-ctx.Done():
			switch ctx.Err() {
			case context.DeadlineExceeded:
				fmt.Println("context timeout exceeded")
			case context.Canceled:
-				fmt.Println("context canceled") // â˜…ã©ã“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸï¼ŸğŸ˜­
+				switch context.Cause(ctx) {
+				case ErrTimeoutOuter:
+					fmt.Println("mainã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«")
+				case ErrTimeoutMiddle:
+					fmt.Println("doHeavyTaskã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«")
+				case ErrTimeoutInner:
+					fmt.Println("callHeavyTaskã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«")
+				default:
+					fmt.Println("ãã®ä»–ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«")
				}
			}
			return
		default:
			// ...å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã©ã®å‡¦ç†
		}
	}
}
```

é‡è¦ãªè€ƒãˆæ–¹ã¨ã—ã¦ã€`cancel(err)` ã‚’è¨­å®šã—ã¦ã‚‚ã€`ctx.Err()`ã®å€¤ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚`ctx.Err()` ã¯å¾“æ¥ã©ãŠã‚Šã€`context.DeadlineExceeded` ã‚„ `context.Canceled` ãŒå–å¾—ã§ãã¾ã™ã€‚ã¤ã¾ã‚Šäº’æ›æ€§ãŒä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ç†ç”±ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ãŸã„å ´åˆã®ã¿ã€`context.Cause(ctx)` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚æœ€åˆã¯ä½¿ã„åˆ†ã‘ãªã‚“ã ã‚ã†ã¨ã‹ã€ã‚„ã‚„é¢å€’ã ãªã¨æ€ã„ã¾ã—ãŸãŒã€è€ƒãˆã¦ã¿ã‚‹ã¨é †å½“ãªåˆ¤æ–­ã§ã™ã€‚

* `ctx.Err()`
    * DoneãŒæœªè¨­å®šã®å ´åˆã€`nil` ã‚’è¿”ã™
    * DoneãŒè¨­å®šã•ã‚ŒãŸã‚‰ã€`context.Canceled` ã‹ `context.DeadlineExceeded` ã‚’è¿”ã™
* `context.Cause(ctx)`
    * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸç‹¬è‡ªã® `error` ã‚’è¿”ã™ã€‚è¨­å®šã—ãŸå ´åˆã€`ctx.Err()`ã¯ `context.Canceled` ã‚’è¿”ã™

ã“ã‚Œã‹ã‚‰æ–°è¦ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„äººã¯ã€ `ctx.Err()` ã‚’ç”¨ã„ãšã€ä¸€æ°—ã« `context.Cause(ctx)` ã‚’ä½¿ã£ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

`Cause()`ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã« `context.Context` ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«`Cause()`ã¨ã„ã£ãŸé–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã‚ŒãŸæ–¹ãŒåˆ©ç”¨è€…ã¨ã—ã¦ã¯ä¾¿åˆ©ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã‚ˆã­ã€‚ã“ã‚Œã¯[Go1äº’æ›æ€§ãƒãƒªã‚·ãƒ¼](https://go.dev/doc/go1compat)ã«æ›¸ã„ã¦ã‚ã‚‹ã‚ˆã†ã«ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯è¨±å¯ã•ã‚Œã¦ãªã„ã¨ã„ã†ã“ã¨ã§å¦å®šã•ã‚Œã¦ã„ã¾ã—ãŸï¼ˆãã®ãŸã‚ã€context.Contextã‚’å¼•æ•°ã«ã¨ã‚‹ç¾åœ¨ã®ã‹ãŸã¡ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚

```diff äº’æ›æ€§ã‚’ã¶ã£å£Šã™APIã‚¤ãƒ¡ãƒ¼ã‚¸
type Context interface {
	Deadline() (deadline time.Time, ok bool)
	Done() <-chan struct{}
	Err() error
	Value(key any) any
+	Cause() error // â˜…å¾Œæ–¹äº’æ›æ€§ã‚’å£Šã™ãŸã‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«æ–°è¦é–¢æ•°ã®è¿½åŠ ã¯ã§ããªã„
}
```

å°‘ã—ã ã‘æƒœã—ã„æ°—ã‚‚ã—ã¾ã™ãŒã€ã™ãã«è¦šãˆã‚‰ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã‹ãªã¨æ€ã„ã¾ã™ã€‚

**2023.1.30 è¿½è¨˜:**

ã“ã®ã‚ãŸã‚Šã®äº’æ›æ€§ã‚’ä¿ã£ãŸAPIæä¾›ã«ã¤ã„ã¦ã¯ã€syumaiã•ã‚“ã®[ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦å…¬é–‹ã—ãŸGoã®interfaceã‚’å¤‰æ›´ã™ã‚‹ã®ã¯é›£ã—ã„ã¨è¨€ã†è©± - ç„¼å£²é£¯åº—](https://blog.syum.ai/entry/2023/01/28/224034) ãŒè©³ã—ã„ã§ã™ï¼

## ä½¿ã„æ–¹ã«ã¤ã„ã¦

è¿½åŠ ã•ã‚ŒãŸé–¢æ•°ã«ã¤ã„ã¦ã€ãƒ‘ãƒƒã¨ã©ã†ã„ã†æŒ™å‹•ã«ãªã‚‹ã‹ç¢ºä¿¡ãŒæŒã¦ãªã‹ã£ãŸ3ã‚±ãƒ¼ã‚¹ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

### 1. cancel(nil) ã‚’å‘¼ã‚“ã ã‚‰ï¼Ÿ

çµè«–â†’ `context.Cause(ctx)` ãŒ `context.Canceled`ã‚’è¿”ã—ã¾ã™ã€‚å°‘ã—æ„å¤–ãªçµæœã«æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```go
func main() {
	ctx, cancel := context.WithCancelCause(context.Background())
	cancel(nil)

	fmt.Println(ctx.Err() == context.Canceled)          // true
	fmt.Println(context.Cause(ctx) == context.Canceled) // true
}
```

`nil` ã‚’è¿”ã•ãªã„ã“ã¨ã§ã€`ctx.Err()` ã‚’ç”¨ã„ãš `context.Cause()` ã§ `context` ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã§ãã‚‹ã‚ˆã†ã™ã‚‹ãŸã‚ã®ç†ç”±ã ã¨æ€ã„ã¾ã™ã€‚


### 2å›å‘¼ã‚“ã ã‚‰ã©ã†ãªã‚‹ï¼Ÿ

çµè«–â†’ æœ€åˆã«è¨­å®šã•ã‚ŒãŸ `cause` ãŒå¸¸ã«å–å¾—ã•ã‚Œã‚‹ã€‚

```go
func main() {
	ctx, cancel := context.WithCancelCause(context.Background())
	cancel(errors.New("1. timeout"))
	cancel(errors.New("2. connection dropped"))

	fmt.Println(context.Cause(ctx)) // 1. timeout
	fmt.Println(context.Cause(ctx)) // 1. timeout
}
```

### 3. è¦ªå­contextã§ãã‚Œãã‚Œ`cancel`ã•ã›ãŸå ´åˆ

ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ã«è¦ªå­contextã‚’ä½œæˆã—ã€è¦ªâ†’å­ã®é †ç•ªã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¾ã—ãŸã€‚

```go
func main() {
	parentCtx, parentCancel := context.WithCancelCause(context.Background())
	childCtx, childCancel := context.WithCancelCause(parentCtx)

	parentCancel(errors.New("parent timeout"))
	childCancel(errors.New("child timeout"))

	fmt.Println(context.Cause(parentCtx)) // parent timeout
	fmt.Println(context.Cause(childCtx))  // parent timeout
}
```

ã“ã®ä¾‹ã®å ´åˆã¯ã€è¦ªã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å†…å®¹ãŒå„ªå…ˆã•ã‚Œã‚‹ã¾ã™ã€‚ `parentCancel`ã€`childCancel` ã®å‘¼ã³å‡ºã—ä½ç½®ã‚’å¤‰ãˆã¦ã¿ã‚‹ã¨å‡ºåŠ›ãŒå¤‰ã‚ã‚‹ã®ã§ï¼ˆåŸºæœ¬ã¯å­ã¯è¦ªã«å½±éŸ¿ã—ãªã„ã€‚è¦ªãŒå…ˆã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã„ãŸã‚‰ã€å­ã¯ãã‚Œã‚’å¼•ãç¶™ãï¼‰ã€å‹•ã‹ã—ã¦ã¿ã‚‹ã¨è‰¯ã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚


## ã¾ã¨ã‚

* å¾“æ¥ã§ã¯ã€ç‰¹ã«è¦ªå­é–¢ä¿‚ã‚’æŒã£ãŸ`context`ã§ãã‚Œãã‚Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒç™ºç”Ÿã—ã†ã‚‹ã¨ãã«åˆ‡ã‚Šåˆ†ã‘ãŒé›£ã—ã‹ã£ãŸãŒã€Go 1.20 ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸã€ `WithCancelCause()` ã¨ `context.Cause()` ã§è§£æ±ºã§ãã€ã©ã“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚“ã å•é¡Œã‚’è§£æ±ºã«å°ã„ã¦ãã‚Œã‚‹
* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ `context.Context` ã¸ã®é–¢æ•°è¿½åŠ ã§ã¯ãªãã€`context` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¸ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã‚ã‚‹

æ¬¡ã¯å·å£ã•ã‚“ã®[Wrapping multiple errors](/articles/20230126a/)ã§ã™ã€‚

