---
title: "Go 1.22ãƒªãƒªãƒ¼ã‚¹é€£è¼‰ vet, log/slog, testing/slogtest"
date: 2024/02/05 00:00:00
postid: a
tag:
  - Go1.22
  - Go
  - Linter
  - slog
category:
  - Programming
thumbnail: /images/20240205a/thumbnail.png
author: çœŸé‡éš¼è¨˜
lede: "Go 1.22ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãƒ„ãƒ¼ãƒªãƒ³ã‚°ã®ã†ã¡ Vet ã¨ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã‚ã‚‹ log/slog, testing/slogtest ã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚"
---
<img src="/images/20240205a/top.png" alt="" width="900" height="601">

## ã¯ã˜ã‚ã«

TIG çœŸé‡ã§ã™ã€‚[Go1.22é€£è¼‰](/articles/20240129a/)ã®6æœ¬ç›®ã§ã™ã€‚

Go 1.22ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãƒ„ãƒ¼ãƒªãƒ³ã‚°ã®ã†ã¡ `Vet` ã¨ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã‚ã‚‹ `log/slog`, `testing/slogtest` ã‚’å–ã‚Šä¸Šã’ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚µãƒãƒª

- `Vet`ã§ãƒ«ãƒ¼ãƒ—å¤‰æ•°ã®å¤‰æ•°ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’æ¤œçŸ¥ã—ãªããªã£ãŸ [#63888](https://github.com/golang/go/issues/63888)
- `Vet`ã§ `slice1 = append(slice1)` ã®æ“ä½œã‚’æ¤œçŸ¥ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ [#63888](https://github.com/golang/go/issues/60448)
- `Vet`ã§ `defer` ã§ `time.Since()` ãŒå‘¼ã¶æ“ä½œã‚’æ¤œçŸ¥ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ [#60448](https://github.com/golang/go/issues/60048)
- `Vet`ã§ä¸æ­£ãª `log/slog` ãªã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’æ¤œçŸ¥ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ [#59407](https://github.com/golang/go/issues/59407)
- `log/slog` ã§ `SetLogLoggerLevel()`ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ [#62418](https://github.com/golang/go/issues/62418)
- `testing/slogtest`ã§ `Run()` é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã‚µãƒ–ãƒ†ã‚¹ãƒˆã®åˆ¶å¾¡ãŒã—ã‚„ã™ããªã‚Šã¾ã—ãŸ [#61758](https://github.com/golang/go/issues/61758)

## Vet ãƒ«ãƒ¼ãƒ—å¤‰æ•°ã®å¤‰æ•°ã‚­ãƒ£ãƒ—ãƒãƒ£ [#63888](https://github.com/golang/go/issues/63888)

[Go 1.22ãƒªãƒªãƒ¼ã‚¹é€£è¼‰å§‹ã¾ã‚Šã¾ã™ & ãƒ«ãƒ¼ãƒ—ã®å¤‰åŒ–ã¨TinyGo 0.31](https://future-architect.github.io/articles/20240129a/#%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E5%A4%89%E5%8C%96-1)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€Goã®ãƒ«ãƒ¼ãƒ—å¤‰æ•°ã¯å˜ãªã‚‹å‚ç…§ã ã£ãŸãŸã‚goroutineã«ãƒ«ãƒ¼ãƒ—å¤‰æ•°ã‚’æ¸¡ã™ã¨ãã«ã¯ã„ãã¤ã‹ã®ãŠä½œæ³•ãŒã‚ã‚Šã¾ã—ãŸã€‚go vetã§ã¯ã‚ã‚ŠãŒã¡ãªãƒŸã‚¹ã‚’æ¤œçŸ¥ã—ã¦ãã‚Œã¦ã„ã¾ã—ãŸã€‚

```go ã‚ˆãã‚ã‚ŠãŒã¡ãªä¾‹
func main() {
	const N = 4
	var wg sync.WaitGroup
	for i := 0; i < N; i++ {
		wg.Add(1)
		go func() { defer wg.Done(); fmt.Println(i) }()
	}
	wg.Wait()
}
```

go1.21ä»¥å‰ã§ã™ã¨ã€æ¬¡ã®ã‚ˆã†ã«0ã‹ã‚‰4ã®å€¤ã‚’å‡ºåŠ›ã™ã‚‹ã¯ãšãŒã€å…¨ãç›´æ„Ÿã¨åã™ã‚‹æŒ™å‹•ã§ã™ã€‚go vetã‚³ãƒãƒ³ãƒ‰ã§ãã®é–“é•ã„ã‚’æ¤œçŸ¥ã—ã¦ãã‚Œã¾ã—ãŸã€‚

```sh
>go run main.go
4
4
4
3

>go vet
main.go:13:44: loop variable i captured by func literal
```

go1.22ä»¥é™ã§ã¯ã€goroutineèµ·å‹•ãªã®ã§é †åºåˆ¶å¾¡ã¯ã•ã‚Œãªã„ã‚‚ã®ã®ï¼ˆã“ã‚Œã¯æƒ³å®šé€šã‚Šã§ã™ã­ï¼‰ã€ãƒ«ãƒ¼ãƒ—å¤‰æ•°ãŒ1ã¤ãšã¤goroutineã«æ¸¡ã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
go run vetloop.go 
3
0
1
2
```

æ­£ã—ãå‹•ã„ãŸã®ã§ã€go vetã‚‚æ¤œçŸ¥ã—ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```
go vet                   
.\main.go:13:44: loop variable i captured by func literal
```

...ã£ã¦ã‚ã‚Œã€å¤‰ã‚ã‚‰ãªã„ã§ã™ã­ã€‚ãªã‚“ã§ã§ã—ã‚‡ã†ã€‚è©¦ã—ãŸã®ã¯ `go1.22rc2` ã§ã™ã€‚ã¾ã ä½œæ¥­ä¸­ãªã®ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ã€‚å¾Œã§èª¿æŸ»ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
    

## Vet Sliceã®æ„å‘³ã®ãªã„append [#63888](https://github.com/golang/go/issues/60448)

ã¿ãªã•ã‚“ã¯çŸ¥ã£ã¦ã„ã¾ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ `append()` ãŒå¼•æ•°ã‚’å–ã‚‰ãªãã¦ã‚‚æ–‡æ³•ä¸Šã¯æœ‰åŠ¹ãªã“ã¨ã‚’ã€‚ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚‚ã§ãå®Ÿè¡Œã§ãã¾ã™ã€‚

```go
package main

import "fmt"

func main() {

	sli1 := []string{"a", "b", "c"}
	sli2 := make([]string, 0)

	for _, v := range sli1 {
		fmt.Println(v)
		sli2 = append(sli2) // â˜…ãƒã‚¤ãƒ³ãƒˆ
	}
	fmt.Println(sli2) // []
}
```

æœ¬æ¥ã®æƒ³å®šã¯ `sli2 = append(sli2, v)` ã ã¨æ€ã„ã¾ã™ãŒã€æ‰‹é•ã„ã§ä¸Šè¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒç”Ÿã¾ã‚Œã‚‹ã¨ã€è‰¯ãã¦æ··ä¹±ã®å…ƒã€é€šå¸¸ã¯ãƒã‚°ã®å…ƒãªã®ã§ã€go vetã§æ¤œçŸ¥ã™ã‚‹äº‹ã«ãªã‚Šã¾ã—ãŸã€‚

ã•ã¦ã€Vetã«è¿½åŠ ã™ã‚‹ã«ã¯[ãƒãƒªã‚·ãƒ¼](https://github.com/golang/go/blob/go1.21.6/src/cmd/vet/README#L18-L23)ã«æ²¿ã£ã¦ã„ã‚‹ã‹ãŒé‡è¦ã§ã™ã€‚ãƒãƒªã‚·ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

* Vetã¯åˆ©ç”¨é »åº¦ãŒé«˜ãã€å®Ÿè¡Œæ™‚é–“ãŒé‡è¦
* ãƒã‚°ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„é™çš„è§£æã§ã‚ã£ã¦ã‚‚ã€æ—¢å­˜ãƒªãƒã‚¸ãƒˆãƒªã§è©²å½“ãŒå°‘ãªã„ã®ã§ã‚ã‚Œã°è¿½åŠ ã—ãªã„

ä»Šå›ã®ãƒã‚§ãƒƒã‚¯å†…å®¹ã§ã™ãŒã€[ç´„ 276,000 ã® Go ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã†ã¡650 ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ 727 ã®å•é¡Œã‚’æ¤œçŸ¥ã—ãŸ](https://github.com/golang/go/issues/60448#issuecomment-1577418105)ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã¯æ•°ãŒå°‘ãªã„ã®ã§åŸºæº–ã‚’æº€ãŸã—ã¦ã„ãªã„ï¼Ÿã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚ã‚Šã¾ã—ãŸã€‚[æ¤œçŸ¥ã—ãŸå†…å®¹ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ©ç”¨é »åº¦ã§ã‚½ãƒ¼ãƒˆã—ãŸãƒˆãƒƒãƒ—20ã‚’æç¤ºã—ã¦](https://github.com/golang/go/issues/60448#issuecomment-1582993504)ã€ã©ã†ã™ã‚‹ã‹ã‚’ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã—ã¦ã„ã¾ã™ã€‚

<img src="/images/20240205a/table.png" alt="" width="1200" height="607" loading="lazy">

ã“ã‚Œã§æµã‚ŒãŒæ±ºã¾ã‚Šã€Vetã«å«ã¾ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚ç©ºä¸­æˆ¦ã«ãªã‚‰ãšé›†è¨ˆèª¿æŸ»ã‚’å®Ÿæ–½ã—ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰åˆ¤æ–­ã™ã‚‹æµã‚Œã¯æ°—æŒã¡ãŒè‰¯ã„ã§ã™ã­ã€‚

ã¡ãªã¿ã«ã§ã™ãŒã€ã“ã®ãƒã‚§ãƒƒã‚¯å†…å®¹ã€[StaticCheckã«ã¯ã™ã§ã«å…¥ã£ã¦ã„ã‚‹](https://staticcheck.dev/docs/checks/#SA4021) ã¨ã„ã†ã“ã¨ã§ã€ãã‚Œã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹ã‚„ã€StaticCheckã¯golangci-lintã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ³ã‚¿ãƒ¼ã§ã‚‚ã‚ã‚‹ã®ã§ã€golangci-lintã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã›ãšã«ä½¿ã£ã¦ã„ã‚‹æ–¹ã¯ã€ã“ã®å¤‰æ›´ã§è¿½åŠ ã§æ¤œçŸ¥ã•ã‚Œã‚‹ã“ã¨ã¯å¤šåˆ†ç„¡ã„ã§ã™ã€‚ãˆãˆãˆãˆã€æ®‹å¿µã€‚


https://github.com/golang/go/blob/go1.21.6/src/cmd/vet/README#L18-L23


## Vet deferã§ time.Since() ã®å‘¼ã³å‡ºã— [#60048](https://github.com/golang/go/issues/60048)

`time.Since()` ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ä½•ã‹ã—ã‚‰ã®æ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ã¨ãã«ç”¨ã„ã‚‰ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€å‡¦ç†æ€§èƒ½ã‚’ãƒ­ã‚®ãƒ³ã‚°ã—ãŸã„å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ããŒã¡ã§ã™ã€‚

```go time.Sinceã®èª¤ç”¨ä¾‹
package main

import (
	"fmt"
	"time"
)

func main() {
	start := time.Now()
	defer fmt.Println(time.Since(start))

	// ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã®ä»£ã‚ã‚Šã«ã€1ç§’ã‚¹ãƒªãƒ¼ãƒ—ã™ã‚‹
	time.Sleep(1 * time.Second)
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ `0s` ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

æ­£ã—ãã¯ä»¥ä¸‹ã§ã™ã€‚

```diff æ­£ã—ã„ä¾‹
package main

import (
	"fmt"
	"time"
)

func main() {
	start := time.Now()
-	defer fmt.Println(time.Since(start))
+	defer func() { fmt.Println(time.Since(start)) }()

	// ä½•ã‹ã—ã‚‰ã®å‡¦ç†ã®ä»£ã‚ã‚Šã«ã€1ç§’ã‚¹ãƒªãƒ¼ãƒ—ã™ã‚‹
	time.Sleep(1 * time.Second)
}
```

å®Ÿè¡Œã™ã‚‹ã¨ `1.0081377s` ãªã©ã¨æƒ³å®šé€šã‚Šã®çµæœã¨ãªã‚Šã¾ã™ã€‚

`defer` ã¸æ¸¡ã•ã‚ŒãŸé–¢æ•°ã®å‘¼ã³å‡ºã—ã¯ã€å…ƒã®é–¢æ•°ãŒreturnã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ãŒã€ãã®é–¢æ•°ã«æ¸¡ã—ãŸ **å¼•æ•°ã¯å³æ™‚è©•ä¾¡**ã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚ `defer\ [^{]*time.Since` ãªã©ã§æ¤œç´¢ã™ã‚‹ã¨ã€`GoogleCloudPlatform/prometheus`ã€€ãªã©å¤§ç‰©ãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚ãƒ’ãƒƒãƒˆã€ä»–ã«ã‚‚å¤šæ•°è©²å½“ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã€Vetå…¥ã‚ŠãŒæ±ºã¾ã‚Šã¾ã—ãŸã€‚

æ¤œçŸ¥ã•ã‚Œã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã­ã€‚

```sh
>go vet
main.go:11:20: call to time.Since is not deferred
```

## Vet log/slogã§ä¸æ­£ãªã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ [#59407](https://github.com/golang/go/issues/59407)

slogã®ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã®ã†ã¡ã€ä»¥ä¸‹ã®2æ¡ä»¶ã§æ¤œçŸ¥ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

1. ã‚­ãƒ¼ãŒstringã§ã‚‚slog.Attrã§ã‚‚ãªã„
2. æœ€å¾Œã®ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼ˆãƒšã‚¢ã«ãªã£ã¦ã„ãªã„ï¼‰

ç°¡å˜ãªä¾‹ã§ã™ã€‚ã“ã®å®Ÿè£…ã§ã¯ `2` ãŒæœ¬æ¥ã‚­ãƒ¼åã«å½“ãŸã‚‹ã®ã§ã™ãŒã€æ•°å€¤å‹ã¨ãªã‚Šä¸æ­£ã§ã™ã€‚

```go 1ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
package main

import "log/slog"

func main() {
	slog.Info("", "key1", 1, 2, 3, slog.String("attr1", "b")) // key1=1 !BADKEY=2 !BADKEY=3 attr1=b
}
```

`run` ã¨ `vet` ã®çµæœã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚vetã§ã¯`2` ãŒ `string` ã‹ `slog.Attr` ã«ã—ã‚ã¨æ•™ãˆã¦ãã‚Œã¾ã™ã­ã€‚ä¾¿åˆ©ã€‚

```sh
>go run main.go
2024/01/30 11:16:35 INFO  key1=1 !BADKEY=2 !BADKEY=3 attr1=b

>go vet
.\main.go:6:27: slog.Info arg "2" should be a string or a slog.Attr (possible missing key or value)
```

ã—ã‹ã—ã€`...` ã‚’åˆ©ç”¨ã—ãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ã§æ¸¡ã—ãŸå ´åˆã¯æ¤œçŸ¥ã§ãã¾ã›ã‚“ã€‚

```go
package main

import "log/slog"

func main() {
	args := []any{"key1", 1, 2, 3, slog.String("attr1", "b")}
	slog.Info("", args...)
}
```

ä¸Šè¨˜ã¯æ¬¡ã®ã‚ˆã†ã«ã€ `run` ã§ã¯æ­£ã—ãç„¡ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã‚ã‚Šã¾ã™ãŒã€ `vet` ã§ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã€‚

```sh
>go run main.go
2024/01/30 11:23:01 INFO  key1=1 !BADKEY=2 !BADKEY=3 attr1=b

>go vet

```

ã“ã®ç‚¹ã¯ãƒ—ãƒ­ãƒãƒ¼ã‚µãƒ«ã§ã‚‚è§¦ã‚Œã‚‰ã‚Œã¦ãŠã‚Šã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ã¯ä¸€å¾‹NGã¨ã—ã¦ã¯ã©ã†ã‹ã€ã¨ã„ã†è©±ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€ã“ã¡ã‚‰ã¯èª¤æ¤œçŸ¥ãŒè€ƒãˆã‚‰ã‚Œã€vetã®ãƒãƒªã‚·ãƒ¼ã‹ã‚‰å¤–ã‚Œã‚‹ã¨ã—ã¦æ£„å´ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚æ–¹é‡ã¨å¯¾å¿œãŒä¸€è²«ã—ã¦ãŠã‚Šã€æœ‰ç„¡ã‚’è¨€ã‚ã•ãªã„æ„Ÿã˜ãŒGoã½ã„ã¨æ€ã„ã¾ã—ãŸã€‚


## log/slog SetLogLoggerLevel()ã®è¿½åŠ  [#62418](https://github.com/golang/go/issues/62418)

slogç¹‹ãŒã‚Šã§ `log/slog` ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã™ã€‚

`SetLogLoggerLevel()` é–¢æ•°ã®æ–°è¦è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚`SetLogLoggerLevel()` ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆlogãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å´ã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆç¾çŠ¶ã¯INFOå›ºå®šã ã¨æ€ã„ã¾ã™ï¼‰ã€‚

æœ¬å½“ã«ãƒ¬ãƒ™ãƒ«ã‚’å¤‰ãˆã¦å‡ºåŠ›ã—ãŸã„å ´åˆã¯ã€æ¨™æº–ã®`log.Printf()`ãªã©ã§ã¯ãªãã€`slog.Warn()` ãªã©ã‚’ä½¿ãˆã°è‰¯ã„ã®ã§ã€æ‚ªããªã„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã ã¨æ€ã„ã¾ã™ãŒã€ãƒ—ãƒ­ãƒãƒ¼ã‚µãƒ«ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ `log` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `stderr`ã«å‡ºåŠ›ã™ã‚‹ãŸã‚ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã§ããŸã»ã†ãŒä¾¿åˆ©ã ã‚ã†ã€ã¨ã„ã†ææ¡ˆã§ã™ã€‚ 

```go
func SetLogLoggerLevel(level Level) (oldLevel Level)
```

ã“ã®é–¢æ•°ã§ã™ãŒã€`slog.SetDefault()` ãŒå‘¼ã°ã‚Œã‚‹å‰ã¨å¾Œã§ã€`slog.Debug()` ãªã©ã€slogçµŒç”±ã®ãƒ­ã‚®ãƒ³ã‚°ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã€‚æ¥­å‹™ãªã©ã§ã¯ `slog.SetDefault()` ã‚’ãŠãã‚‰ãmainã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«è¿‘ã„å ´æ‰€ã§å‘¼ã³å‡ºã™ã¨æ€ã†ãŸã‚ã€é€šå¸¸ã¯ç´°ã‹ã„æŒ™å‹•ã®å·®ã‚’æ„è­˜ã—ãªãã¦ã‚‚è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚ç¹°ã‚Šè¿”ã—ã¾ã™ãŒæœ¬æ¥ã®æ„å›³ã¨ã—ã¦ã¯ã€æ¨™æº–ã®logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

...ã¨è¨€ã„ãªãŒã‚‰ã‚‚ã‚‚ `slog.SetDefault()` ã‚’å‘¼ã³å‡ºã•ãšã€
`SetLogLoggerLevel()` ã‚’å‘¼ã‚“ã§ã€slogã¨æ¨™æº–ã®logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æŒ™å‹•ãŒã©ã†å¤‰ã‚ã‚‹ã‹è©¦ã—ã¾ã™ã€‚

```go
package main

import (
	"log"
	"log/slog"
)

func main() {
	log.Println("========ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¯INFO=========")
	log.Print("log debugğŸ›")   // log debug
	slog.Debug("slog debugğŸ›") // â˜…no output
	slog.Info("slog infoğŸ”")   // INFO info

	log.Println("========ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’DEBUGã«å¤‰æ›´=========")
	slog.SetLogLoggerLevel(slog.LevelDebug)
	log.Print("log debugğŸ›")   // log debug
	slog.Debug("slog debugğŸ›") // â˜…ã€ŒDEBUG debugã€ã¨ãªã‚Šå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹
	slog.Info("slog infoğŸ”")   // INFO info
}
```

```log
>go run main.go
2024/01/30 12:53:14 ========ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã¯INFO=========
2024/01/30 12:53:14 log debugğŸ›
2024/01/30 12:53:14 INFO slog infoğŸ”
2024/01/30 12:53:14 ========ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’DEBUGã«å¤‰æ›´=========
2024/01/30 12:53:14 log debugğŸ›
2024/01/30 12:53:14 DEBUG slog debugğŸ›
2024/01/30 12:53:14 INFO slog infoğŸ”
```

å‹•ãã‚’è¦‹ã‚‹ã¨ã€`slog.SetLogLoggerLevel(slog.LevelDebug)` ã‚’å‘¼ã³å‡ºã™ã¨ã€`slog.Debug()` ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚`slog.SetDefault()`ã‚’å‘¼ã³å‡ºã•ãªã„å‰æã ã¨ã€`slog` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸çµŒç”±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹ã‚ˆã†ãªæŒ™å‹•ã¨ãªã‚Šã¾ã™ã€‚

æ¬¡ã«ã€ `slog.SetDefault()` ã§logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ç”¨ã„ã‚‹ãƒ­ã‚¬ãƒ¼ã‚’slogå½¢å¼ã«å¤‰æ›´ã—ãŸå ´åˆã«ã€`slog.SetLogLoggerLevel()` ãŒã©ã†å½±éŸ¿ã™ã‚‹ã‹è©¦ã—ã¾ã™ã€‚

```go
package main

import (
	"log"
	"log/slog"
	"os"
)

func main() {
	slog.SetLogLoggerLevel(slog.LevelError)
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, nil)))

	slog.Info("slog info: go1.22 blog seriesğŸ”")
	slog.Warn("slog warn: go1.22 blog seriesâš ï¸")
	slog.Error("slog error: go1.22 blog seriesğŸš¨")

	log.Print("log print: go1.22 blog seriesğŸ“")
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ã€logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸çµŒç”±ã®å‡ºåŠ›ã‚‚ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒERRORã§å‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®ã‚±ãƒ¼ã‚¹ã§ã™ã¨ã€ã‚„ã‚„ã“ã—ã„ã§ã™ãŒslogå´ã®ERRORæœªæº€ã®ãƒ­ã‚°ã¯æŠ‘åˆ¶ã•ã‚Œã¾ã›ã‚“ã€‚

```json5 å‡ºåŠ›çµæœ
>go run main2.go
{"time":"2024-01-30T13:02:46.9325009+09:00","level":"INFO","msg":"slog info: go1.22 blog seriesğŸ”"}
{"time":"2024-01-30T13:02:46.9659968+09:00","level":"WARN","msg":"slog warn: go1.22 blog seriesâš ï¸"}
{"time":"2024-01-30T13:02:46.966573+09:00","level":"ERROR","msg":"slog error: go1.22 blog seriesğŸš¨"}
{"time":"2024-01-30T13:02:46.966573+09:00","level":"ERROR","msg":"log print: go1.22 blog seriesğŸ“"}
```

å°‘ã—ã‚„ã‚„ã“ã—ã„ã§ã™ãŒã€ `slog.SetLogLoggerLevel()` ã¯ `slog.SetDefault()` ã®å‘¼ã³å‡ºã—æœ‰ç„¡ã§ã€ `slog.Debug()`ã‚„`slog.Info()` ãªã©ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã‚‹ã¨æ€ã£ãŸæ–¹ãŒç†è§£ã—ã‚„ã™ã„ã§ã™ã€‚

ã¡ãªã¿ã«ã€æ¬¡ã®ã‚ˆã†ã«ã€ `slog.SetLogLoggerLevel()` ã§ã¯ERRORãƒ¬ãƒ™ãƒ«ã€ `slog.SetDefault()` ã«ã‚ãŸã™Handlerã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«WARNã‚’æ¸¡ã—ã¦ã‚‚ã€ æ¨™æº–ã®`log` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å‡ºåŠ›ã¯ERRORãƒ¬ãƒ™ãƒ«ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```go
package main

import (
	"log"
	"log/slog"
	"os"
)

func main() {
	slog.SetLogLoggerLevel(slog.LevelError) // ERROR
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelWarn, //WARN
	})))
	log.Print("log print: go1.22 blog seriesğŸ™")
}
```

```json å‡ºåŠ›çµæœ
> go run main.go
{"time":"2024-01-30T13:20:15.5788942+09:00","level":"ERROR","msg":"log print: go1.22 blog seriesğŸ™"}
```

é€†ã«ã€`slog.SetLogLoggerLevel()` ã§ã¯INFOãƒ¬ãƒ™ãƒ«ã«è¿”ã‚‹ã¨å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚logãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒINFOã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ­ã‚¬ãƒ¼ã®ãƒ¬ãƒ™ãƒ«ãŒWARNã®ãŸã‚ã€WARNæœªæº€ã§ã‚ã‚‹ `log.Print()` ã®å†…å®¹ã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚

```diff
package main

import (
	"log"
	"log/slog"
	"os"
)

func main() {
-	slog.SetLogLoggerLevel(slog.LevelError) // ERROR
+	slog.SetLogLoggerLevel(slog.LevelInfo) // INFO
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelWarn, //WARN
	})))
	log.Print("log print: go1.22 blog seriesğŸ™")
}
```

```log
>go run main.go

```

ç†ã«ã‹ãªã£ãŸæŒ™å‹•ã«è¦‹ãˆã¾ã™ãŒã€ãã‚Œãã‚Œã«ã—ãŸãƒ­ã‚°ãƒ¬ãƒ™ãƒ«å€¤ã«ã‚ˆã£ã¦ã¯ã€`log`, `slog` ã©ã¡ã‚‰ã‚‚ä½µç”¨ã™ã‚‹ã¨æ··ä¹±ã—ãã†ã§ã™ã­ã€‚



## testing/slogtest Run()ã®è¿½åŠ  [#61758](https://github.com/golang/go/issues/61758)

slogã¯ `slog.Handler` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æº€ãŸã™ã“ã¨ã§ã€æœ€çµ‚çš„ãªå‡ºåŠ›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚ã•ãã»ã©ã® `slog.NewJSONHandler()` ã¯JSONã§å‡ºåŠ›ã™ã‚‹Handlerã§ã—ãŸã‚ˆã­ã€‚èª¿ã¹ã‚‹ã¨[go-slog/awesome-slog](https://github.com/go-slog/awesome-slog) ã®ã‚ˆã†ãªAwesomeãªãƒªãƒã‚¸ãƒˆãƒªã‚‚è¦‹ã¤ã‹ã‚‹ã»ã©ã€å¤šãã®HandlerãŒå­˜åœ¨ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

Go1.21ã®slogã®ç™»å ´ã¨ã¨ã‚‚ã«ã€Handlerã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ `testing/slogtest` ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸãŒã€ãã“ã«Run()é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

ã¾ãšslogtestãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã£ã¦ãªã«ï¼Ÿã£ã¦ã“ã¨ã§ã™ãŒã€ç°¡å˜ã«ã„ã†ã¨äºˆã‚æº–å‚™ã•ã‚ŒãŸslogã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å‘¼ã³å‡ºã™ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ã§ã™ã€‚ã©ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã‹ã¨è¨€ã„ã¾ã™ã¨ã€[slogtest.go](https://tip.golang.org/src/testing/slogtest/slogtest.go) ã®caseså¤‰æ•°ã‚’è¦‹ã‚‹ã¨åˆ†ã‹ã‚Šã¾ã™ã€‚

```go slogtestã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
var cases = []testCase{
	{
		name:        "built-ins",
		explanation: withSource("this test expects slog.TimeKey, slog.LevelKey and slog.MessageKey"),
		f: func(l *slog.Logger) {
			l.Info("message")
		},
		checks: []check{
			hasKey(slog.TimeKey),
			hasKey(slog.LevelKey),
			hasAttr(slog.MessageKey, "message"),
		},
	},
	{
		name:        "attrs",
		explanation: withSource("a Handler should output attributes passed to the logging function"),
		f: func(l *slog.Logger) {
			l.Info("message", "k", "v")
		},
		checks: []check{
			hasAttr("k", "v"),
//ä»¥ä¸‹ç•¥
```

GoDocã®[Example](https://pkg.go.dev/testing/slogtest@master)ã«æ›¸ã„ã¦ã‚ã‚‹ä½¿ã„æ–¹ã¨ã—ã¦ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®slog.Handlerã‚’å¼•æ•°ã«æ¸¡ã—ã¦ã€ `slogtest.TestHandler(h, results)` ã®ã‚ˆã†ã«å‘¼ã³å‡ºã™ã¨ã€ä¸Šè¨˜ã§ã‚ã’ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```go
import (
	"bytes"
	"encoding/json"
	"log"
	"log/slog"
	"testing/slogtest"
)

func TestMySlogHandler() {
	var buf bytes.Buffer
	h := slog.NewJSONHandler(&buf, nil)

	results := func() []map[string]any {
		var ms []map[string]any
		for _, line := range bytes.Split(buf.Bytes(), []byte{'\n'}) {
			if len(line) == 0 {
				continue
			}
			var m map[string]any
			if err := json.Unmarshal(line, &m); err != nil {
				t.Fatal(err) // JSONã«å¤‰æ›ã§ããªã„å ´åˆã¯å¤±æ•—æ‰±ã„
			}
			ms = append(ms, m)
		}
		return ms
	}
	err := slogtest.TestHandler(h, results)
	if err != nil {
		t.Errorf("report from testing/slogtest.TestHandler: %v", err)
	}

}
```

ã“ã®èª²é¡Œã§ã™ãŒã€[ãƒ—ãƒ­ãƒãƒ¼ã‚µãƒ«](https://github.com/golang/go/issues/61758#issue-1836738770)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€TestSlogHandler ã¨ã„ã†1ã¤ã®ãƒ•ãƒ©ãƒƒãƒˆãªé–¢æ•°ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã©ã“ã‹1ã‚±ãƒ¼ã‚¹ãŒè½ã¡ãŸéš›ã«åˆ‡ã‚Šåˆ†ã‘ãŒã—ã«ãã„ã¨ã„ã†ã“ã¨ãŒä¸Šã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚ãã“ã§`go test -run TestSlogHandler/ignore.an.empty.Attr` ã®ã‚ˆã†ã«å„1ã‚±ãƒ¼ã‚¹ã”ã¨ã‚µãƒ–ãƒ†ã‚¹ãƒˆã§å‹•ã‹ã™ã“ã¨ã‚’è¡Œã† `Run()` é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

slog.Handlerã‚’ä½œã‚‹äººã¯è¦ãƒã‚§ãƒƒã‚¯ã ã¨æ€ã„ã¾ã™ã€‚ä½œã‚Šæ–¹ã¯[ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](https://github.com/golang/example/blob/master/slog-handler-guide/README.md)ã‚‚ã‚ã‚‹ã‚ˆã†ãªã®ã§ã€ä½µã›ã¦ç¢ºèªã™ã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚


## ã•ã„ã”ã«

å®Ÿã¯Go1.22ã®2æœ¬ç›®ã§ã™ã€‚ãƒ—ãƒ­ãƒãƒ¼ã‚µãƒ«ã‚„ãã®ã‚„ã‚Šå–ã‚Šã‚’è¦‹ã‚‹ã®ãŒæ¥½ã—ãã¦2æ ã„ãŸã ãã¾ã—ãŸã€‚

Vetã¯å¥½ãã§ã€[go vet ã«å«ã¾ã‚Œãªã„ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãªé™çš„è§£æãƒ„ãƒ¼ãƒ«ãŸã¡ ](/articles/20231005a/)è¨˜äº‹ã‚’æ›¸ã„ãŸã‚Šã€æ—¥ã€…golangci-lintã®enableã¨ã™ã‚‹Linterã‚’å¢—ã‚„ã™æ´»å‹•ã‚’è¡Œã„å¾³ã‚’ç©ã‚“ã§ã„ã¾ã™ã€‚

slogã¯å®Ÿè·µå°å…¥ãŒã§ãã¦ã„ãªã„ã§ã™ãŒã€ã“ã‚Œã‚’æ©Ÿä¼šã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã„ããŸã„ã§ã™ã€‚

å¼•ãç¶šããƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼æŠ€è¡“ãƒ–ãƒ­ã‚°ã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚Goè¨€èªã§é–‹ç™ºã§ãã‚‹ä»²é–“ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ£ãƒªã‚¢æ¡ç”¨ã§ã®å¿œå‹Ÿã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚


