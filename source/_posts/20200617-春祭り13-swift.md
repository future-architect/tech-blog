title: "æ˜¥ã®å…¥é–€ç¥­ã‚Š ğŸŒ¸ #13 Swift Compositional Layoutså…¥é–€ï¼šè¤‡é›‘ãªCollectionViewã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã™ã‚‹"
date: 2020/06/17 10:20:21
tag:
  - Swift
  - ã‚¢ãƒ—ãƒª
category:
  - Programming
thumbnail: /images/20200617/thumbnail.png
author: ç¦è°·å‹å®
featured: false
lede: "ãŠä»•äº‹ã§ã¯ä¸»ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é ˜åŸŸã§é–‹ç™ºã—ã¦ã„ã¾ã™ãŒã€è¶£å‘³ã§iOSã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ãŠã‚Šã€æ˜¥ã®å…¥é–€ç¥­ã‚Šã®ç¤¾å†…ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒã‚ã£ãŸã®ã§æ›¸ã„ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚iOSã‚¢ãƒ—ãƒªã§è¨˜äº‹ã‚„å†™çœŸãªã©ã‚’ä¸€è¦§è¡¨ç¤ºã•ã›ãŸã„å ´åˆã€å¿…ãšã¨è¨€ã£ã¦ã„ã„ã»ã©CollectionViewï¼ˆã‚ã‚‹ã„ã¯TableViewï¼‰ãŒæ¡ç”¨ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚"
---

[æ˜¥ã®å…¥é–€ç¥­ã‚Š](https://future-architect.github.io/articles/20200529/)ã®ç¬¬13å¼¾ã§ã™ã€‚

# ã¯ã˜ã‚ã«
TIG ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¦ãƒ‹ãƒƒãƒˆã®ç¦è°·ï¼ˆãµãã‚„ï¼‰ã§ã™ã€‚

ãŠä»•äº‹ã§ã¯ä¸»ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é ˜åŸŸã§é–‹ç™ºã—ã¦ã„ã¾ã™ãŒã€è¶£å‘³ã§iOSã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã¦ãŠã‚Šã€æ˜¥ã®å…¥é–€ç¥­ã‚Šã®ç¤¾å†…ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒã‚ã£ãŸã®ã§æ›¸ã„ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

iOSã‚¢ãƒ—ãƒªã§è¨˜äº‹ã‚„å†™çœŸãªã©ã‚’ä¸€è¦§è¡¨ç¤ºã•ã›ãŸã„å ´åˆã€å¿…ãšã¨è¨€ã£ã¦ã„ã„ã»ã©CollectionViewï¼ˆã‚ã‚‹ã„ã¯TableViewï¼‰ãŒæ¡ç”¨ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

iPhoneãŒç™ºå£²ã•ã‚ŒãŸå½“åˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ã€ç¸¦ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒä¸¦ã¶ã ã‘ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã—ãŸãŒã€æ˜¨ä»Šã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸€è¦§æ€§ãƒ»è¦–èªæ€§ã‚’ã‚ˆã‚Šé«˜ã‚ã‚‹ãŸã‚ã«ã€ç¸¦ã«ã‚‚æ¨ªã«ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹CollectionViewãŒä¸€èˆ¬çš„ã«ãªã£ã¦ãã¦ã„ã¾ã™ã€‚
<img src="/images/20200617/1.png" class="img-small-size">

# Compositional Layouts

ãã“ã§Compositional Layoutsã®ç™»å ´ã§ã™ã€‚

Compositional Layoutsã¯WWDC2019ã«ç™ºè¡¨ã•ã‚ŒãŸè¤‡é›‘ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã™ã‚‹ãŸã‚ã®è€ƒãˆæ–¹ã§ã™ã€‚CollectionViewã«ãŠã„ã¦ã¯`UICollectionViewCompositionalLayout`ã‚¯ãƒ©ã‚¹[^6]ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

[^6]: [https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout](https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout)

Compositional Layoutsã®è©³ã—ã„è§£èª¬ã¯WWDC2019ã®å‹•ç”»[^2]ã‚’è¦‹ã‚‹ã‹ã€ãã‚Œã‚’å…ƒã«è§£èª¬ã—ãŸè¨˜äº‹[^3]ã‚‚ã‚ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã¾ãŸå…¬å¼ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰[^7]ã‚‚ã‹ãªã‚Šå‚è€ƒã«ãªã‚‹ãŸã‚ãŠã™ã™ã‚ã§ã™ã€‚

â€»å…¬å¼ã§ã¯iOS13ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒã€iOS13ä»¥å‰ã§ã‚‚åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª[^1]ãŒã§ã¦ã„ã¾ã™ã€‚
[^1]: [https://github.com/kishikawakatsumi/IBPCollectionViewCompositionalLayout](https://github.com/kishikawakatsumi/IBPCollectionViewCompositionalLayout)

[^2]: [https://developer.apple.com/videos/play/wwdc2019/215/](https://developer.apple.com/videos/play/wwdc2019/215/)
[^3]: [https://qiita.com/shiz/items/a6032543a237bf2e1d19#%E8%83%8C%E6%99%AF%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E6%99%82%E4%BB%A3%E3%81%AE%E5%A4%89%E5%8C%96](https://qiita.com/shiz/items/a6032543a237bf2e1d19#%E8%83%8C%E6%99%AF%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E6%99%82%E4%BB%A3%E3%81%AE%E5%A4%89%E5%8C%96)
[^7]: [https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/using_collection_view_compositional_layouts_and_diffable_data_sources](https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/using_collection_view_compositional_layouts_and_diffable_data_sources)

# ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªFuture Tech Blogãƒªãƒ¼ãƒ€ãƒ¼ã‚’ä½œã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

ã‚½ãƒ¼ã‚¹å…¨é‡ã¯[ã“ã¡ã‚‰](https://github.com/popai306/FutureTechBlogReader)ã€‚
â€»ä»¥é™ã®è§£èª¬ã¯Compositional Layoutsã®å®Ÿè£…éƒ¨åˆ†ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

<img src="/images/20200617/photo_20200617_01.gif" class="img-middle-size" style="border:solid 1px #000000">

### itemãƒ»groupãƒ»sectionã®æ§‹æˆã‚’æ±ºã‚ã‚‹

Compositional Layoutã¯ itemãƒ»groupãƒ»sectionã€ãã—ã¦sectionã‚’å†…åŒ…ã™ã‚‹layoutã«ã‚ˆã‚Šæ§‹æˆã•ã‚Œã¾ã™ã€‚
<img src="/images/20200617/2.png" class="img-middle-size">

ä»Šå›ä½œã‚‹ã‚¢ãƒ—ãƒªã®UIã‚’ä¾‹ã«ã€itemãƒ»groupãƒ»sectionã‚’ã©ã†æ§‹æˆã™ã‚‹ã‹ã«ã¤ã„ã¦ç¤ºã—ãŸã®ãŒä¸‹è¨˜ã®ç”»åƒã§ã™ã€‚
<img src="/images/20200617/3.png" class="img-middle-size" style="border:solid 1px #000000">

ãã‚Œã§ã¯Layoutã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### Compositional Layoutã§å®Ÿè£…ã™ã‚‹
ã¾ãšå¤§æ ã®Sectionã‹ã‚‰æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```swift
func createLayout() -> UICollectionViewLayout {
    let sectionProvider = { (sectionIndex: Int,
        layoutEnvironment: NSCollectionLayoutEnvironment) -> NSCollectionLayoutSection? in
        
        let section = NSCollectionLayoutSection(group: group)
        section.orthogonalScrollingBehavior = sectionKind.scrollingBehavior()

        //â‘ 
        section.interGroupSpacing = 10
        //â‘¡
        section.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 15, bottom: 0, trailing: 15)

        // section headerã®å®šç¾©
        let sectionHeaderSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1.0),
                                                       heightDimension: .estimated(44))
        let sectionHeader = NSCollectionLayoutBoundarySupplementaryItem(layoutSize: sectionHeaderSize, elementKind: "header", alignment: .top)
        section.boundarySupplementaryItems = [sectionHeader]

        return section
    }
    
    let config = UICollectionViewCompositionalLayoutConfiguration()
    //â‘¢
    config.interSectionSpacing = 30

    let layout = UICollectionViewCompositionalLayout(sectionProvider: sectionProvider, configuration: config)
    return layout
}
```

`sectionheaderSize`ã®`widthDimension`ã«å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¦ã„ã‚‹`fractionalWidth(1.0)`ã¯ã€sectionã®æ¨ªå¹…ã¨åŒã˜æ¯”ç‡ã§headerã®æ¨ªå¹…ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚[^4]

[^4]: [https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199059-fractionalwidth](https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199059-fractionalwidth)

ã¾ãŸã€`heightDimension`ã«å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¦ã„ã‚‹`estimated(44)`ã¯ã€44ã§é«˜ã•ã‚’æŒ‡å®šã™ã‚‹ã‚‚ã®ã®æœ€çµ‚çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«æ±ºå®šã—ã¾ã™ï¼ˆï¼ã€Œå¼±ã„å®šç¾©ã€ã¨å‹æ‰‹ã«å‘¼ã‚“ã§ã„ã¾ã™ï¼‰ã€‚[^5]
[^5]: [https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199057-estimated](https://developer.apple.com/documentation/uikit/nscollectionlayoutdimension/3199057-estimated)

<br>
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸­ã®ä½™ç™½å®šç¾©â‘ â‘¡â‘¢ã¯ãã‚Œãã‚ŒUIä¸Šã®ä¸‹è¨˜ã®ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
<img src="/images/20200617/4.png" class="img-middle-size" style="border:solid 1px #000000">

ç¶šã„ã¦itemãƒ»groupã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```swift
func createLayout() -> UICollectionViewLayout {
    let sectionProvider = { (sectionIndex: Int,
        layoutEnvironment: NSCollectionLayoutEnvironment) -> NSCollectionLayoutSection? in
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®enum
        guard let sectionKind = SectionLayoutKind(rawValue: sectionIndex) else { fatalError("unknown section kind") }
        
        // itemã®å®šç¾©
        let itemSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1.0),
                                              heightDimension: .fractionalHeight(1.0))
        let item = NSCollectionLayoutItem(layoutSize: itemSize)

        // groupã®å®šç¾©    
        let groupWidth = layoutEnvironment.container.effectiveContentSize.width - 15 * 2 - 5
        let groupSize = NSCollectionLayoutSize(widthDimension: .absolute(groupWidth),
                                               heightDimension: .absolute(150))
        let group: NSCollectionLayoutGroup
        if sectionKind == .recommend {
            group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitem: item, count: 2)
        } else {
            group = NSCollectionLayoutGroup.vertical(layoutSize: groupSize, subitem: item, count: 2)
        }
        group.interItemSpacing = NSCollectionLayoutSpacing.fixed(10)
        
        // sectionã®å®šç¾©
        let section = NSCollectionLayoutSection(group: group)
        section.orthogonalScrollingBehavior = sectionKind.scrollingBehavior()
        section.interGroupSpacing = 10
        section.contentInsets = NSDirectionalEdgeInsets(top: 0, leading: 15, bottom: 0, trailing: 15)
        
        let sectionHeaderSize = NSCollectionLayoutSize(widthDimension: .fractionalWidth(1.0),
                                                       heightDimension: .estimated(44))
        let sectionHeader = NSCollectionLayoutBoundarySupplementaryItem(layoutSize: sectionHeaderSize, elementKind: "header", alignment: .top)
        section.boundarySupplementaryItems = [sectionHeader]
        return section
    }
    
    let config = UICollectionViewCompositionalLayoutConfiguration()
    config.interSectionSpacing = 30

    let layout = UICollectionViewCompositionalLayout(sectionProvider: sectionProvider, configuration: config)
    return layout
}
```
#### SectionLayoutKind

`SectionLayoutKind`ã¯ã‚¢ãƒ—ãƒªä¸­ã®`ãŠã™ã™ã‚`ã‚„`æ˜¥ã®å…¥é–€ç¥­ã‚Š`ãªã©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’enumã§å®šç¾©ã—ãŸã‚‚ã®ã§ã€
ä¸‹è¨˜ã®é€šã‚Šå®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```swift
enum SectionLayoutKind: Int {
    case recommend, springEntry, goTips, serverless
    func scrollingBehavior() -> UICollectionLayoutSectionOrthogonalScrollingBehavior {
        switch self {
        case .recommend:
            return .continuous
        default:
            return .groupPaging
        }
    }
}
```
ã‚‚ã—å›ºå®šçš„ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãªã‚‰enumã§å®šç¾©ã—ã¦ãŠãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

ä¸€æ–¹ã§enumã§å®šç¾©ã™ã‚‹ã¨enumå†…ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’ã„ã‚ã„ã‚ç®¡ç†ã—ãŸããªã‚Šã¾ã™ãŒã€`createLayout()`å†…ã«ã‚‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾©ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€è¦‹é€šã—ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«ã‚‚æœ€ä½é™ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã®ã¿enumå†…ã§å®šç¾©ã™ã¹ãã ã¨æ€ã„ã¾ã™ã€‚ï¼ˆã“ã®å ´åˆæ°´å¹³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®æŒ™å‹•ï¼‰

#### groupã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾©

```swift
let group: NSCollectionLayoutGroup
if sectionKind == .recommend {
    // â‘ ãŠã™ã™ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®groupå®šç¾©
    group = NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitem: item, count: 2)
} else {
    // â‘¡ãŠã™ã™ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ã®ã®groupå®šç¾©
    group = NSCollectionLayoutGroup.vertical(layoutSize: groupSize, subitem: item, count: 2)
}
// itemé–“ã®ç©ºç™½ã®å®šç¾©
group.interItemSpacing = NSCollectionLayoutSpacing.fixed(10)
```

â‘¡ãŠã™ã™ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ã®ã®groupå®šç¾©

`NSCollectionLayoutGroup.vertical(layoutSize: groupSize, subitem: item, count: 2)`
`vertical`ã§`count`ã‚’"ï¼’"ã«ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦å‚ç›´ã«itemã‚’ï¼’ã¤ã‚¹ã‚¿ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚

â‘ ãŠã™ã™ã‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®groupå®šç¾©

ãŠã™ã™ã‚ã®è¨˜äº‹ã¯ç”»åƒã‚’å¤§ããã—ã¦ç›®ç«‹ãŸã›ãŸã„ã®ã§æ°´å¹³ã«itemã‚’ï¼’ã¤ã‚¹ã‚¿ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚
`NSCollectionLayoutGroup.horizontal(layoutSize: groupSize, subitem: item, count: 2)`

#### groupSizeã®å®šç¾©

```swift
let groupWidth = layoutEnvironment.container.effectiveContentSize.width - 15 * 2
let groupSize = NSCollectionLayoutSize(widthDimension: .absolute(groupWidth), heightDimension: .absolute(150))
```

`layoutEnvironment.container.effectiveContentSize`ã¯collectionViewã®æç”»é ˜åŸŸã‚’æ„å‘³ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ãŒã€ä¾‹ãˆã°ã‚¹ãƒãƒ›ã®å‘ãã«ã‚ˆã£ã¦ã‚¢ãƒ—ãƒªã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰ãˆãŸã„å ´åˆã¯ã“ã®å€¤ã‚’ä½¿ã£ã¦åˆ†å²å‡¦ç†ã‚’æ›¸ã‘ã°å¯¾å¿œã§ãã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ä»¥ä¸ŠãŒä»Šå›ã®ã‚¢ãƒ—ãƒªã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆéƒ¨åˆ†ã«é–¢ã™ã‚‹è§£èª¬ã«ãªã‚Šã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’é™¤ã„ã¦38è¡Œã§æ›¸ã‘ã¾ã—ãŸã€‚

åŒã˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’UICollectionViewLayoutã®ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ã§å®Ÿç¾ã—ã‚ˆã†ã¨ã—ãŸã‚‰ã‹ãªã‚Šã®è¡Œæ•°ãƒ»é›£æ˜“åº¦ã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚itemãƒ»groupãƒ»sectionã®ç†è§£ã•ãˆã™ã‚Œã°ç§ã®ã‚ˆã†ãªåˆå­¦è€…ã§ã‚‚ç°¡æ˜“ã‹ã¤ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã§ãã‚‹ã®ã§ã€ä»Šå¾Œã®iOSã‚¢ãƒ—ãƒªé–‹ç™ºã§ã©ã‚“ã©ã‚“æ¡ç”¨ã•ã‚Œã¦ã„ãã®ã§ã¯ã¨æ€ã„ã¾ã™ã€‚

ãã®éš›ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ï¼

