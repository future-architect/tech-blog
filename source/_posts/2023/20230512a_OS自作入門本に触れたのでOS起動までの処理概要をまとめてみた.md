---
title: "OS自作入門本に触れたのでOS起動までの処理概要をまとめてみた"
date: 2023/05/12 00:00:00
postid: a
tag:
  - OS
  - 書籍
  - ゼロからのOS自作入門
category:
  - Infrastructure
thumbnail: /images/20230512a/thumbnail.png
author: 栗栖大樹
lede: "[ゼロからのOS自作入門]（通称：みかん本）を読み始めたので、mikanOSが立ち上がるまでの処理概要をまとめてみました。"
---
## はじめに

はじめまして、2022年4月入社・Technology Inovation Group（TIG）所属の栗栖です。

[春の入門ブログ連載](/articles/20230417a/)の16日目です。

最近、[ゼロからのOS自作入門](https://www.amazon.co.jp/gp/product/B08Z3MNR9J?ie=UTF8&psc=1&linkCode=sl1&tag=k-tw-22&linkId=09411e4f3f3b631351b67d7c6d518fec&language=ja_JP&ref_=as_li_ss_tl)（通称：みかん本）を読み始めました。

ソースレベルで解説があるため深い理解を得やすいですが、OS起動まで処理フローの記載がなく、全体感を把握するのに苦労したので私なりにmikanOSが立ち上がるまでの処理概要をまとめてみました。

<img src="/images/20230512a/OSBook.png" alt="OSBook" width="400" height="533" loading="lazy">

## OS起動までの流れ

OS起動までの流れとしては以下の通り。

<img src="/images/20230512a/ブートローダ実行までのフロー.drawio.png" alt="ブートローダ実行までのフロー.drawio.png" width="121" height="331" loading="lazy">

### ①電源起動

CPUがBIOSに格納されたバイナリプログラムを実行する。

※PCの電源が切れるとメインメモリの内容は消え、次回起動時にCPUは命令を読み取ることができなくなる。電源を切っても記憶内容を保持する不揮発性メモリ（ROM）にBIOSを書き込むことで、CPUがBIOSを実行可能にしている。

### ②UEFI BIOSの実行

コンピュータを初期化（CPU動作モードの設定、PCIデバイスの検出）し、接続されたストレージ内のブートローダを検索する。
/EFI/BOOT/BOOTX64.EFIをメインメモリ上に展開し実行する。

### ③ブートローダの実行

カーネルファイルを読み出し実行する。

### ④カーネルの実行

システムの機能やリソースを管理し制御する。

## ブートローダとカーネルの用意

UEFI BIOSがブートローダの実行までしてくれるので、ブートローダとカーネルの実行可能ファイルを用意する。

### ソースファイル

#### ブートローダ

以下の処理があれば良い。

* メモリマップ（物理メモリの配置と使用状況を把握する情報源）を取得する。
* カーネルファイルのヘッダ情報を読み込みイメージベース（バイナリファイルがメモリ上で配置されるアドレス）を特定する
* カーネルを起動しブートサービスを停止させる。

#### カーネル

自分が作るOSでやりたいことを書く。(描画、デバイス制御、アプリケーション等)

### ビルド

C/C++で書いたブートローダとカーネルのソースコードは以下手順で実行する。

<img src="/images/20230512a/ファイル構成.drawio.png" alt="ファイル構成.drawio.png" width="231" height="481" loading="lazy">

#### コンパイル

ソースコードからオブジェクトファイル(バイナリコードだが実行可能ではない)を生成する。
※1つのソースコードは1つのオブジェクトファイルとなるため、差分のあるソースコードだけを再コンパイルすることで時間を節約できる。

#### リンク

複数のオブジェクトファイルを結合して実行可能なバイナリファイルを生成する。

### ディスクイメージの生成

ビルドされたファイルをディスクイメージに組み込む。

手順

1. FAT32のディスクイメージファイルを作成する
2. ディスクイメージを適当なディレクトリ（例：mnt）マウントする
3. マウントされたイメージにビルドされたファイルをコピーする

```sh
├─mnt
   ├─EFI
   │  ├─BOOT
   │      └─BOOTX64.EFI #ブートローダ
   ├─kernel.elf #カーネル
   └─memmap # メモリマップ
```

4. ディスクイメージをアンマウントする。

実機環境であればシステムドライブにディスクイメージを焼いてブートする、

仮想環境であればQEMU等の仮想マシンでディスクイメージを起動するとOSが立ち上がる。

## さいごに

本を読む前はOSは複雑で個人では取り掛かりにくい印象がありましたが、立ち上げるために必要な1つ1つの処理は意外と単純でした。立ち上がった後のカーネルの持つリソース管理や制御の実装部分は複雑なので大変だと思います。

次は寒河江さんの[Swiftの自動テスト〜導入と基本的なテスト手法〜](/articles/20230515a/)です。
